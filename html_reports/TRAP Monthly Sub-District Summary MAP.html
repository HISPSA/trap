<html>

<head>

	<style>
		.MainTbl{
			border-left:2px solid #000;border-top:2px solid #000;border-right:2px solid #000;border-bottom:1px solid #000;
		}
		.SecondaryTbl{
			border-left:1px solid #000;border-top:1px solid #000;border-right:1px solid #000;
		}
		.labelHeader {
			font-weight:800;border-left:1px solid #000;border-bottom:1pt solid #000;text-align:center;padding:4px;
		}
		.labelmonthName{
			font-weight:800;border-left:1px solid #000;border-bottom:1pt solid #000;text-align:center;padding:4px;background-Color:#f5f5f5
		}
		.cellNumeric{
			text-align: right;padding:5px;
		}
		.rounded{
		    -webkit-border-radius: 4px 4px 4px 4px;
		    -moz-border-radius: 4px 4px 4px 4px;
		    border-radius: 4px 4px 4px 4px;
		}
		#map {  width:800px;height:600px;position:relative;top:0;left:0;padding:0; margin:0;border:0;border-radius:0;background-image:-webkit-linear-gradient(top, #ffffff 0%, #ffffff 100%);cursor: default;} /*width: 100%; height: 100%;*/
	</style>

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />

	<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>

	<script language=javascript>

		function getParameterByName(name) {0
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results = regex.exec(location.search);
			return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		var ou = getParameterByName('ou');
		var pe = getParameterByName('pe');

	</script>

</head>

<body>

<div id="" style="padding:0">

<div id="map" style="padding:0"></div>
<div class=''>Map 1. Area surrounding X</div>

<table border=0 cellpadding=0 cellspacing=0 style='min-width:75%;' id='tblMaster' class='MainTbl rounded'>
	<tr>
		<td colspan=1 class='labelHeader' style='border-left:0;'>{PLACEHOLDER}</td>
		<td colspan=1 class='labelHeader' id='1_peFprev'></td>
		<td colspan=1 class='labelHeader' id='1_peFtarget'></td>
		<td colspan=1 class='labelHeader' id='1_peFYTDtarget'></td>
		<td colspan=1 class='labelHeader' id='1_peFYTDactual'></td>
		<td colspan=1 class='labelHeader' id='1_peFYTDgap'></td>
		<td colspan=1 class='labelHeader' id='1_peFYTDprogress'></td>
		<td colspan=1 class='labelHeader' id='1_peMMtarget'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM04'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM05'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM06'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM07'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM08'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM09'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM10'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM11'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM12'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM01'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM02'></td>
		<td colspan=1 class='labelmonthName' id='1_peMM03'></td>
	</tr>
</table>

</div>

<input type="button" value="Export to Excel" id="exceldownloadbutton" name="exceldownloadbutton" onclick="javascript:fnExcelReport()" class="no-print" style="display:none;width:140px;position:absolute;left:306px;top:65px;">

 <script language=javascript>


	var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ];
	var dxCore = 'LHTsLNCZnlX,IpNKseiGOfP,KnQn2N452bE,Bmo4lk1FhgP,S6BlQpoZVhQ';
	var dxCat = 'wyZ6KAmjZeD,mLVlvjLwl9q';
	var dxCoreCat = '';
	var lblCat = 'Actual,Target';
	var dxNonRunningTotal = 'IpNKseiGOfP';
	var peMMrange = '';
	var peMMrangeEnd = '';
	var peMMlabelEnd = '';
	var peMMprevYRangeEnd = '';

	var sort_by = function(field, reverse, primer){
		var key = primer ? 
			function(x) {return primer(x[field])} : 
			function(x) {return x[field]};
		reverse = !reverse ? 1 : -1;
		return function (a, b) {
			return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
			} 
	}

	var peMcurr = parseInt(pe.substring(4,6));
	var peFcurr = parseInt(pe.substring(0,4));

	if (peMcurr <= 3){
		peFcurr = (peFcurr-1);
	}

	var peFprev = (peFcurr-1); //parseInt(((parseInt(peMcurr)<4) ? (peFcurr-1) : peFcurr));
	var peFcurrSuff = parseInt(peFcurr.toString().substring(2,4));
	var peFprevSuff = parseInt(peFprev.toString().substring(2,4));

	var peFYcurr = (peFcurr+'April');
	var peFYprev = (peFprev+'April');

	if (dxNonRunningTotal.length > 0) {
		peMMprevYRangeEnd = (peFcurr + '02');
	}

	document.getElementById('1_peFprev').innerHTML = (peFprev + '/' + peFcurrSuff + '<br>Baseline');
	document.getElementById('1_peFtarget').innerHTML = (peFcurr + '/' + ((peFcurrSuff)+1) + '<br>Target');
	document.getElementById('1_peFYTDtarget').innerHTML = (peFcurr + '/' + ((peFcurrSuff)+1) + '<br>YTD Target');
	document.getElementById('1_peFYTDactual').innerHTML = (peFcurr + '/' + ((peFcurrSuff)+1) + '<br>YTD Actual');
	document.getElementById('1_peFYTDgap').innerHTML = (peFcurr + '/' + ((peFcurrSuff)+1) + '<br>YTD Gap');
	document.getElementById('1_peFYTDprogress').innerHTML = (peFcurr + '/' + ((peFcurrSuff)+1) + '<br>YTD %<br>Progress');
	document.getElementById('1_peMMtarget').innerHTML = (peFcurr + '/' + ((peFcurrSuff)+1) + '<br>Monthly<br>Target');


	for (var p = 4; p <= 12; p++){
		document.getElementById('1_peMM' + paddNumeric(p,2)).innerHTML = ((months[p-1]).toString().substring(0,3)+'-'+peFcurrSuff);
		if ( (p > peMcurr) && (peMcurr > 4) ){
			document.getElementById('1_peMM' + paddNumeric(p,2)).style.display='none';
		} else {
			peMMrange += (peFcurr+paddNumeric(p,2)+';');
			peMMlabelEnd = ((months[p-1]).toString().substring(0,3)+'-'+peFcurrSuff);
			peMMrangeEnd = (peFcurr+paddNumeric(p,2));
		}
	}
	for (var p = 1; p <= 3; p++){
		document.getElementById('1_peMM' + paddNumeric(p,2)).innerHTML = ((months[p-1]).toString().substring(0,3)+'-'+(peFcurrSuff+1));
		if ( (peMcurr > 3) || (p > peMcurr) ){
			document.getElementById('1_peMM' + paddNumeric(p,2)).style.display='none';
		} else {
			peMMrange += ((peFcurr+1)+paddNumeric(p,2)+';');
			peMMlabelEnd = ((months[p-1]).toString().substring(0,3)+'-'+(peFcurrSuff+1));
			peMMrangeEnd = ((peFcurrSuff+1)+paddNumeric(p,2));
		}
	}

	var template1 = document.getElementById('tblMaster').outerHTML.replace('MainTbl','SecondaryTbl');

	document.getElementById('tblMaster').outerHTML = document.getElementById('tblMaster').outerHTML.replace('{PLACEHOLDER}',dhis2.report.organisationUnit.name)


	for (var p = 4; p <= 12; p++){
		document.getElementById('1_peMM' + paddNumeric(p,2)).innerHTML = ((months[p-1]).toString().substring(0,3)+'-'+peFcurrSuff);
	}
	for (var p = 1; p <= 3; p++){
		document.getElementById('1_peMM' + paddNumeric(p,2)).innerHTML = ((months[p-1]).toString().substring(0,3)+'-'+(peFcurrSuff+1));
	}

	var myYTDCALCvals = [];

	//URL for Dx Core List
	var sDxCore = ('../api/dataElements.json?filter=id:in:['+dxCore+']&fields=id,name,shortName,displayName');

	 $.ajax({
		url: sDxCore,
		error: function (xhr, ajaxOptions, thrownError) {
			console.log('error: Data Element Lookup');
		},
		success : function(dataDE){

			var sort_by = function(field, reverse, primer){

			var key = primer ? 
				function(x) {return primer(x[field])} : 
				function(x) {return x[field]};

			reverse = !reverse ? 1 : -1;

			return function (a, b) {
				return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
				} 
			}

			var ArrDx = dxCore.split(',');
			var tbl1 = document.getElementById('tblMaster');

			for (var p = 0; p < dataDE.dataElements.length; p++){

				myYTDCALCvals.push ({
					ou: ou,
					dx: dataDE.dataElements[p].id,
					YPrevactual: 0,
					YTDtarget: 0,
					YTDactual: 0,
					YTDgapNum: 0,
					YTDgapPer: 0,
					CALCtarget: 0,
					CALCactual: 0,
					MMgrandTot: 0
				});

				var tr = document.createElement('tr');
				tr.setAttribute("id",dataDE.dataElements[p].id+'_'+ou+'_row');
				tbl1.appendChild(tr);

				var td = document.createElement('td');
				td.setAttribute("style",'padding:3px;border-bottom:1px solid #000;width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;');
				td.setAttribute("id",'1_'+dataDE.dataElements[p].id+'_1');
				tr.appendChild(td);

				td.innerText = (dataDE.dataElements[p].name).replace('TRAP_','');

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				//td.setAttribute("id",'1_'+dataDE.dataElements[p].id+'_1');
				td.setAttribute("id",dataDE.dataElements[p].id+'.wyZ6KAmjZeD_'+ou+'_'+peFYprev);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				//td.setAttribute("id",'1_'+dataDE.dataElements[p].id+'_2');
				td.setAttribute("id",dataDE.dataElements[p].id+'.mLVlvjLwl9q_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				//td.setAttribute("storedValue",'');
				td.setAttribute("id",dataDE.dataElements[p].id+'.YTDtarget_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				//td.setAttribute("storedValue",'');
				td.setAttribute("id",dataDE.dataElements[p].id+'.YTDactual_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				td.setAttribute("id",dataDE.dataElements[p].id+'.DifferenceGap_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				//td.setAttribute("id",'1_'+dataDE.dataElements[p].id+'_6');
				td.setAttribute("id",dataDE.dataElements[p].id+'.DifferencePercentage_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				td.setAttribute("id",dataDE.dataElements[p].id+'.mLVlvjLwl9q_'+ou+'_'+peMMrange.split(';')[0]);
				tr.appendChild(td);

				for (var r = 4; r <= 12; r++){
					if ( (r <= peMcurr) || (peMcurr <= 4) ){
						var td = document.createElement('td');
						td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
						td.setAttribute("class",'cellNumeric');
						//td.setAttribute("id",'1_'+dataDE.dataElements[p].id+'_MM_'+peFcurr+paddNumeric(r,2));
						td.setAttribute("id",dataDE.dataElements[p].id+'.wyZ6KAmjZeD_'+ou+'_'+peFcurr+paddNumeric(r,2));
						tr.appendChild(td);
					}
				}
				for (var r = 1; r <= 3; r++){
					if ( (r <= peMcurr) && (peMcurr <= 4) ){
						var td = document.createElement('td');
						td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
						td.setAttribute("class",'cellNumeric');
						//td.setAttribute("id",'1_'+dataDE.dataElements[p].id+'_MM_'+(peFcurr+1)+paddNumeric(r,2));
						td.setAttribute("id",dataDE.dataElements[p].id+'.wyZ6KAmjZeD_'+ou+'_'+(peFcurr+1)+paddNumeric(r,2));
						tr.appendChild(td);
					}
				}

			}

			var dv = document.createElement('div');
			dv.setAttribute('style','padding:8px 0 8px 0;');
			dv.innerText = 'Table 1. Monthly sub-district summary for financial year F' + peFcurr + ' ('+dhis2.report.organisationUnit.name+', period ending ' + peMMlabelEnd + ')';
			document.getElementById('mainPage').appendChild(dv);

			var dxArrCore = dxCore.split(',')
			var dxArrCat = dxCat.split(',')

			for (var n = 0; n < dxArrCore.length; n++){
				for (var o = 0; o < dxArrCat.length; o++){
					dxCoreCat += (dxArrCore[n]+'.'+dxArrCat[o]+';');
				}
			}

			dxCoreCat = dxCoreCat.substring(dxCoreCat,dxCoreCat.length-1);

			//URL for parent-OU 
			var sOU = ('../api/organisationUnits/' + ou + '.json?fields=id,name,displayName,displayShortName,coordinates,featureType,children[id,name,displayName,displayShortName,coordinates,featureType]');

			$.ajax({
				url: sOU,
				error: function (xhr, ajaxOptions, thrownError) {
					console.log('error: Data Element Lookup');
				},
				success : function(dataOU){

					var OUchildren = '';

					for (var p = 0; p < dataOU.children.length; p++){
						OUchildren += (dataOU.children[p].id + ';');
					}

					OUchildren = OUchildren.substring(OUchildren,OUchildren.length-1);

					for (var n = 0; n < dataDE.dataElements.length; n++){

						var dv = document.createElement('div');
						dv.setAttribute('id','dv_'+dataDE.dataElements[n].id);
						dv.setAttribute('style','padding:8px 0 8px 0;');
						document.getElementById('mainPage').appendChild(dv);

						dv.innerHTML = (template1.replace('tblMaster','tblDx_'+dataDE.dataElements[n].id));
						dv.innerHTML = (dv.innerHTML).replace('{PLACEHOLDER}',dataDE.dataElements[n].name).replace('TRAP_','');

						var tbl1 = document.getElementById('tblDx_'+dataDE.dataElements[n].id);

						for (var p = 0; p < dataOU.children.length; p++){

							myYTDCALCvals.push ({
								ou: dataOU.children[p].id,
								dx: dataDE.dataElements[n].id,
								YPrevactual: 0,
								YTDtarget: 0,
								YTDactual: 0,
								YTDgapNum: 0,
								YTDgapPer: 0,
								CALCtarget: 0,
								CALCactual: 0,
								MMgrandTot: 0
							});

							var tr = document.createElement('tr');
							tr.setAttribute("id",dataDE.dataElements[n].id+'_'+dataOU.children[p].id+'_row');
							tbl1.appendChild(tr);

							var td = document.createElement('td');
							td.setAttribute("style",'padding:3px;border-bottom:1px solid #000;width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;');
							td.setAttribute("id",dataDE.dataElements[n].id+'_'+dataOU.children[p].id+'_0');
							tr.appendChild(td);

							td.innerText = (dataOU.children[p].name);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dataDE.dataElements[n].id+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+peFYprev);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							//td.setAttribute("id",dataDE.dataElements[n].id+'_'+dataOU.children[p].id+'_2');
							td.setAttribute("id",dataDE.dataElements[n].id+'.mLVlvjLwl9q_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dataDE.dataElements[n].id+'.YTDtarget_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dataDE.dataElements[n].id+'.YTDactual_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dataDE.dataElements[n].id+'.DifferenceGap_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							//td.setAttribute("id",dataDE.dataElements[n].id+'_'+dataOU.children[p].id+'_6');
							td.setAttribute("id",dataDE.dataElements[n].id+'.DifferencePercentage_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dataDE.dataElements[n].id+'.mLVlvjLwl9q_'+dataOU.children[p].id+'_'+peMMrange.split(';')[0]);
							tr.appendChild(td);

							for (var r = 4; r <= 12; r++){
								if ( (r <= peMcurr) || (peMcurr <= 4) ){
									var td = document.createElement('td');
									td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
									td.setAttribute("class",'cellNumeric');
									td.setAttribute("id",dataDE.dataElements[n].id+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+peFcurr+paddNumeric(r,2));
									tr.appendChild(td);
								}
							}
							for (var r = 1; r <= 3; r++){
								if ( (r <= peMcurr) && (peMcurr <= 4) ){
									var td = document.createElement('td');
									td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
									td.setAttribute("class",'cellNumeric');
									td.setAttribute("id",dataDE.dataElements[n].id+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+(peFcurr+1)+paddNumeric(r,2));
									tr.appendChild(td);
								}
							}

						}

						var dv1 = document.createElement('div');
						dv1.setAttribute('style','padding:8px 0 8px 0;');
						dv1.innerText = 'Table '+(n+2)+'. Facility totals for ['+(dataDE.dataElements[n].name).replace('TRAP_','')+']';
						dv.appendChild(dv1);

					}

					var sDataGet = '../api/26/analytics.json?dimension=dx:'+dxCore.replace(',',';')+';'+dxCoreCat+'&dimension=pe:'+( (peMMprevYRangeEnd.length > 0) ? (peMMprevYRangeEnd + ';') : '' )+peMMrange+peFYcurr+';'+peFYprev+'&dimension=ou:'+ou+';'+OUchildren+'&displayProperty=NAME&outputIdScheme=UID';
					console.log(sDataGet);

					$.ajax({
						url: sDataGet,
						error: function (xhr, ajaxOptions, thrownError) {
							console.log('error: getting report data values');
						},
						success : function(dataVal){

							var comboRESULTALL = [];

							for (var i = 0; i < dataVal.rows.length; i++){

								var myRowID = (dataVal.rows[i][0] + '_' + dataVal.rows[i][2] + '_' + dataVal.rows[i][1]);
								var myValue = dataVal.rows[i][3];

								comboRESULTALL.push ({ id: myRowID, value: myValue });

								try {
									document.getElementById(myRowID).innerText = formatNumber(parseFloat(myValue).toFixed(1).toString().replace('.0',''));
								}
								catch(err) {
									//console.log('No match: '+myRowID +': ['+myValue+']')
								}

							}

							var PEarr = peMMrange.substring(peMMrange,peMMrange.length-1).split(';')

							for (var a = 0; a < myYTDCALCvals.length; a++){

								for (var i = 0; i < comboRESULTALL.length; i++){

									// DX and OU match
									if ( ( (comboRESULTALL[i].id).indexOf(myYTDCALCvals[a].dx) >= 0) && ( (comboRESULTALL[i].id).indexOf(myYTDCALCvals[a].ou) >= 0) ){

										if ( ( (comboRESULTALL[i].id).indexOf(peFYprev) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) < 0) ) {
											myYTDCALCvals[a].YPrevactual = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
										} else {
											// PE match of Prev-Year-End-MM value for RunningTotal element
											if ( ( (comboRESULTALL[i].id).indexOf(peMMprevYRangeEnd) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].YPrevactual = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
										}

										// YTD target
										if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && ( (comboRESULTALL[i].id).indexOf(peFYcurr) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) < 0) ) {
											myYTDCALCvals[a].YTDtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
										} else {
											// PE match of Current-Range-End-MM value for RunningTotal element
											if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && ( (comboRESULTALL[i].id).indexOf(peMMrangeEnd) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].YTDtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												myYTDCALCvals[a].CALCtarget += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
										}
										// YTD actual
										if ( ( (comboRESULTALL[i].id).indexOf('wyZ6KAmjZeD') >= 0) && ( (comboRESULTALL[i].id).indexOf(peFYcurr) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) < 0) ) {
											myYTDCALCvals[a].YTDactual = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
										} else {
											// PE match of Current-Range-End-MM value for RunningTotal element
											if ( ( (comboRESULTALL[i].id).indexOf('wyZ6KAmjZeD') >= 0) && ( (comboRESULTALL[i].id).indexOf(peMMrangeEnd) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].YTDactual = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												myYTDCALCvals[a].CALCactual += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
										}


										for (var p = 0; p < PEarr.length; p++){
											if ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) < 0){
												// YTD CALC of TARGET
												if ( ( (comboRESULTALL[i].id).indexOf('.mLVlvjLwl9q') >= 0) && ((comboRESULTALL[i].id).indexOf(PEarr[p]) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) < 0) ) {
													myYTDCALCvals[a].CALCtarget += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												}
												// YTD CALC of ACTUAL
												if ( ( (comboRESULTALL[i].id).indexOf('.wyZ6KAmjZeD') >= 0) && ((comboRESULTALL[i].id).indexOf(PEarr[p]) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) < 0) ) {
													myYTDCALCvals[a].CALCactual += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												}
											}

											myYTDCALCvals[a].MMgrandTot += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											
										}


									}

								}

							}

							for (var a = 0; a < myYTDCALCvals.length; a++){

								document.getElementById(myYTDCALCvals[a].dx+'.wyZ6KAmjZeD_'+myYTDCALCvals[a].ou+'_'+peFYprev).innerText = formatNumber( parseFloat(myYTDCALCvals[a].YPrevactual) );
								document.getElementById(myYTDCALCvals[a].dx+'.mLVlvjLwl9q_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].YTDtarget) );
								document.getElementById(myYTDCALCvals[a].dx+'.YTDtarget_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].CALCtarget) );
								document.getElementById(myYTDCALCvals[a].dx+'.YTDactual_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].CALCactual) );
								document.getElementById(myYTDCALCvals[a].dx+'.DifferenceGap_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].CALCactual) - parseFloat(myYTDCALCvals[a].CALCtarget) );


								if (parseFloat(myYTDCALCvals[a].CALCactual) - parseFloat(myYTDCALCvals[a].CALCtarget) < 0){
									document.getElementById(myYTDCALCvals[a].dx+'.DifferenceGap_'+myYTDCALCvals[a].ou+'_'+peFYcurr).style.color = '#C70000';
								}


								if (myYTDCALCvals[a].CALCtarget > 0) {
									document.getElementById(myYTDCALCvals[a].dx+'.DifferencePercentage_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( (parseFloat(myYTDCALCvals[a].CALCactual) / parseFloat(myYTDCALCvals[a].CALCtarget) * 100 ).toFixed(1)) + '%';
									document.getElementById(myYTDCALCvals[a].dx+'.DifferencePercentage_'+myYTDCALCvals[a].ou+'_'+peFYcurr).style.backgroundColor = getBackgroundPerformanceColor((parseFloat(myYTDCALCvals[a].CALCactual) / parseFloat(myYTDCALCvals[a].CALCtarget) * 100 ));;
								}

								if (myYTDCALCvals[a].MMgrandTot == 0) { 
									document.getElementById(myYTDCALCvals[a].dx+'_'+myYTDCALCvals[a].ou+'_row').style.display = 'none';
								}

							}






							geojson_decode = function(geoFeatures, levelOrder, tyFilter) {
								var geojson = {
									type: 'FeatureCollection',
									crs: {
										type: 'EPSG',
										properties: {
											code: '4326'
										}
									},
									features: []
								};

								levelOrder = levelOrder || 'ASC';

								for (var i = 0, ou, gpid = '', gppg = ''; i < geoFeatures.length; i++) {
									ou = geoFeatures[i];

									// grand parent
									if (Ext.isString(ou.pg) && ou.pg.length) {
										var ids = Ext.Array.clean(ou.pg.split('/'));

										// grand parent id
										if (ids.length >= 2) {
											gpid = ids[ids.length - 2];
										}

										// grand parent parentgraph
										if (ids.length > 2) {
											gppg = '/' + ids.slice(0, ids.length - 2).join('/');
										}
									}
									
									if (tyFilter){

										if ((ou.featureType) === tyFilter) {

											geojson.features.push({
												type: 'Feature',
												geometry: {
													type: ou.featureType,
													coordinates: JSON.parse(ou.coordinates)
												},
												properties: {
													id: ou.id,
													name: ou.name,
													shortName: 	ou.shortName,
													hasCoordinatesDown: '',
													hasCoordinatesUp: '',
													level: ou.le,
													grandParentParentGraph: '',
													grandParentId: '',
													parentGraph: '',
													parentId: '',
													parentName: '',
													type: ''
												} 
											});

										}
									} else {

										geojson.features.push({
											type: 'Feature',
											geometry: {
												type: ou.featureType,
												coordinates: JSON.parse(ou.coordinates)
											},
											properties: {
												id: ou.id,
												name: ou.name,
												shortName: ou.shortName,
												hasCoordinatesDown: '',
												hasCoordinatesUp: '',
												level: ou.level,
												grandParentParentGraph: '',
												grandParentId: '',
												parentGraph: '',
												parentId: '',
												parentName: '',
												type: ''
											} 
										});

									}
								}

								return geojson;
							}

							//console.log(dataOU.coordinates);

							var g_geoJSONlayerData = geojson_decode(dataOU);

							//console.log(g_geoJSONlayerData);

							var g_mapLeft = new L.map('map', { renderer: L.svg({ padding: 100 }) }).setView([-28.5, 26], 6);

							var g_baseMapLayerOpacity = 0.75;

							var Esri_DeLorme = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Specialty/DeLorme_World_Base_Map/MapServer/tile/{z}/{y}/{x}', {opacity: g_baseMapLayerOpacity, attribution: 'Tiles &copy; Esri &mdash; Copyright: &copy;2012 DeLorme',minZoom: 1,maxZoom: 11});
							var Esri_WorldGrayCanvas = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {opacity: g_baseMapLayerOpacity, attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',maxZoom: 16});
							var Esri_WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {opacity: g_baseMapLayerOpacity, attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'});
							//var Esri_WorldPhysical = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {opacity: g_baseMapLayerOpacity, attribution: 'Tiles &copy; Esri &mdash; Source: US National Park Service',maxZoom: 8});
							var Esri_WorldStreetMap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {opacity: g_baseMapLayerOpacity, attribution: 'Tiles &copy; Esri &mdash; Source: Esri'});
							var Esri_WorldShadedRelief = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {opacity: g_baseMapLayerOpacity, attribution: 'Tiles &copy; Esri &mdash; Source: Esri',	maxZoom: 13});
							var OpenMapSurfer_Roads = L.tileLayer('http://korona.geog.uni-heidelberg.de/tiles/roads/x={x}&y={y}&z={z}', {opacity: g_baseMapLayerOpacity, maxZoom: 20,attribution: 'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});
							var Open_StreetMap = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',});
							//var OpenStreetMap_Mapnik = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, maxZoom: 19,attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});
							var OpenTopoMap = L.tileLayer('http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, maxZoom: 17,attribution: 'Map data: &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'});
							var OpenStreetMap_BlackAndWhite = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, maxZoom: 18,attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});
							var Hydda_Full = L.tileLayer('http://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, attribution: 'Tiles courtesy of <a href="http://openstreetmap.se/" target="_blank">OpenStreetMap Sweden</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});
							var HikeBike_HikeBike = L.tileLayer('http://{s}.tiles.wmflabs.org/hikebike/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, maxZoom: 19,attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});
							var CartoDB_Positron = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains: 'abcd',maxZoom: 19});
							var CartoDB_PositronNoLabels = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains: 'abcd',maxZoom: 19});
							var CartoDB_DarkMatter = L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains: 'abcd',maxZoom: 19});
							var CartoDB_DarkMatterNoLabels = L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains: 'abcd',maxZoom: 19});

							g_baseMapCollection = {
								"PRINT: Esri.DeLorme": Esri_DeLorme,
								"PRINT: Esri.WorldGrayCanvas": Esri_WorldGrayCanvas,
								"PRINT: Esri.WorldImagery": Esri_WorldImagery,
								"PRINT: Esri.WorldStreetMap": Esri_WorldStreetMap,
								"PRINT: Esri.WorldShadedRelief": Esri_WorldShadedRelief,
								"PRINT: Open.MapSurfer.Roads": OpenMapSurfer_Roads,
								"PRINT: StreetMap": Open_StreetMap,
								"StreetMap.BlackAndWhite":OpenStreetMap_BlackAndWhite,
								"Topographic":OpenTopoMap,
								"Hydda.Full":Hydda_Full,
								"HikeBike":HikeBike_HikeBike,
								"PRINT: CartoDB.Positron":CartoDB_Positron,
								"PRINT: CartoDB.Positron.NoLabels":CartoDB_PositronNoLabels,
								"PRINT: CartoDB.Dark":CartoDB_DarkMatter,
								"PRINT: CartoDB.Dark.NoLabels":CartoDB_DarkMatterNoLabels
							};

							var layerControl = L.control.layers(g_baseMapCollection, null, {position:'bottomright', opacitySlider: true}).addTo(g_mapLeft);
							var g_baseLayer = CartoDB_Positron.addTo(g_mapLeft);

							var g_geoJSONlayerObj = L.geoJson(g_geoJSONlayerData, {
								style: AdaptStyle,
								onEachFeature: onEachFeature
							}).addTo(g_mapLeft);

							document.getElementById('map').style.width = document.getElementById('tblMaster').style.width;




						}
					});

				}

			});

		}
	
	 })

	function getBackgroundPerformanceColor(varVal){
		if (isNumber(varVal)) {
			if (parseFloat(varVal) > 110){
				return '#656AFC'; // blue
			}
			if ( (parseFloat(varVal) >= 95) && (parseFloat(varVal) <= 110) ){
				return '#90FC65'; // green
			}
			if ( (parseFloat(varVal) >= 80) && (parseFloat(varVal) < 95) ){
				return '#FCDC65'; // orange
			}
			if (parseFloat(varVal) < 80){
				return '#FC6565'; // red
			}
		}
	}

	function paddNumeric(varVal,iPadd){
		var sPadd = '';
		for (var i = (varVal.toString().length); i < iPadd; i++){
			sPadd += '0';
		}
		return (sPadd.toString() + varVal.toString());
	}

	function isNumber(n) {
		return !isNaN(parseFloat(n)) && isFinite(n);
	}

	function returnAttributeValue(Arr,sName,ReturnDefault){
		var sReturn = '';
		for(var i = 0; i < Arr.length; i++) {
			if (Arr[i].attribute.name == sName){
				sReturn = Arr[i].value;
			}
		}
		if (sReturn.length == 0){
			return ReturnDefault
		}
		else{
			return sReturn
		}
	}

	function formatNumber(num) {
		return ("" + num).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, function($1) { return $1 + "," });
	}

	function AdaptStyle(feature){

		if (feature.properties['id'] == ou)	{
			return {
				weight: 3,
				opacity: 1,
				color: '#0080CD',
				zIndex: 0,
				dashArray: '5, 5',
				fillOpacity: 0,
				fillColor: '#ffffff'
			}
		} else {
			return {
				weight: 1,
				opacity: 0.85, 
				color: '#606060', 
				dashArray: '0',
				fillOpacity: 0.85,
				fillColor: '#ffffff', 
				radius: 20,
				className: 'pointShadow'
			}
		}

	}

	function onEachFeature(feature, layer) {

		if (feature.geometry.type == 'Point'){
			var myIcon = L.divIcon({ iconSize: new L.Point(20, 20), className: 'Point', 
				html: ('<div style="background-Color:#7181BF;border:1px solid #f5f5f5;border-radius:20px;"></div>')
			});
			L.marker([feature.geometry.coordinates[1],feature.geometry.coordinates[0]], {icon: myIcon}).addTo(g_mapLeft);
		} else {
			L.marker(featureMidPoints(feature.geometry.coordinates[0][0]), {icon: myIcon}).addTo(g_mapLeft);
		}

		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight
		});

	}


	function highlightFeature(e) {
	
		var layer = e.target;
		var FillOp = 0.75; 
		var updateInfo = 1;

		if (layer.feature.properties['id'] == ou){

			layer.setStyle({
				weight: 3,
				opacity: 1,
				color: '#0080CD',
				zIndex: 0,
				dashArray: '5, 5',
				fillOpacity: 0,
				fillColor: '#ffffff'});

		} else {

			layer.setStyle({
				weight: 2, 
				color: '#3A5C8A', 
				opacity: 1,
				fillOpacity: 0.5,
				fillColor: '#ffffff'});
		}

	}

	function fnExcelReport(){

		var tab_text="<table border='2px'><tr bgcolor='#87AFC6'>";
		var textRange; var j=0;
		tab = document.getElementById('tblMaster'); // id of table

		for(j = 0 ; j < tab.rows.length ; j++) {     
			tab_text=tab_text+tab.rows[j].innerHTML+"</tr>";
			//tab_text=tab_text+"</tr>";
		}

		tab_text=tab_text+"</table>";
		tab_text= tab_text.replace(/<A[^>]*>|<\/A>/g, "");//remove if u want links in your table
		tab_text= tab_text.replace(/<img[^>]*>/gi,""); // remove if u want images in your table
		tab_text= tab_text.replace(/<input[^>]*>|<\/input>/gi, ""); // reomves input params

		var ua = window.navigator.userAgent;
		var msie = ua.indexOf("MSIE "); 

		//link.download = "QPR_HEALTH_" + document.getElementById('ouvalue').innerHTML + "_" + (document.getElementById('peFprev').innerHTML).replace('/','_') + "_fQ" + (document.getElementById('peFq').innerHTML).substring(0,1) + ".xls";
		if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./)) {     // If Internet Explorer
			txtArea1.document.open("txt/html","replace");
			txtArea1.document.write(tab_text);
			txtArea1.document.close();
			txtArea1.focus(); 
			sa=txtArea1.document.execCommand("SaveAs",true,"Say Thanks to Sumit.xls");
		} else {                //other browser not tested on IE 11
			sa = window.open('data:application/vnd.ms-excel,' + encodeURIComponent(tab_text)); 
		}

		return (sa);
	}

</script>

</body>
</html>