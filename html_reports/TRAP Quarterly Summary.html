<html>

<head>

	<style>
		table.MainTbl{
			border-left:2px solid #000;border-top:2px solid #000;border-right:2px solid #000;border-bottom:1px solid #000;
		}
		table.SecondaryTbl{
			border-left:1px solid #000;border-top:1px solid #000;border-right:1px solid #000;
		}
		th.labelHeader {
			font-weight:800;border-left:1px solid #000;border-bottom:1pt solid #000;text-align:center;padding:4px;color:#000;
		}
		th.labelquarterName{
			font-weight:800;border-left:1px solid #000;border-bottom:1pt solid #000;text-align:center;padding:4px;background-Color:#f5f5f5;color:#000;
		}
		td.cellNumeric, div.cellNumeric{
			text-align: right;padding:4px;cursor: default;
		}
		.rounded{
		    -webkit-border-radius: 4px 4px 4px 4px;
		    -moz-border-radius: 4px 4px 4px 4px;
		    border-radius: 4px 4px 4px 4px;
		}
		table.perfBar { width:100%;height:100;padding:0; }
		#reportOverview {padding:4px;display:none;}
		table, th, td, div, span, a {font-family:Calibri,sans-serif,Arial;}
		li {padding:4px;}
		#chart1Title {padding:12px 0 4px 8px;font-weight: 400;}
		.tableTitle {padding:12px 0 4px 4px;font-weight: 400;}

        #leafMap {
                    width:1000px;height:800px;
                    position:relative;top:0;left:0;
                    padding:0; margin:0;border:2px solid #C0C0C0; 
                    background-Color:#fff;
                    -webkit-border-radius: 8px 8px 8px 8px;-moz-border-radius: 8px 8px 8px 8px;border-radius: 8px 8px 8px 8px;
                    cursor: default; 
                }

        .landingPage {width:100%; }
        .leaflet-control-attribution {display:none;}
        .leaflet-control-layers-list {text-align: left;}

        @media all {
            .page-break	{ display: none; }
        }
        @media print {
            footer {page-break-after: always;}
			.leaflet-control { display: none !important; }
        }

	</style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
	<script src="//dhis2-cdn.org/v227/plugin/chart.js"></script>

	<script language=javascript>

		function getParameterByName(name) {0
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results = regex.exec(location.search);
			return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		var ou = getParameterByName('ou');
		var pe = getParameterByName('pe');
		var repUID = getParameterByName('uid');

	</script>

</head>

<body>

	<div id="reportHeader">

	<table id='logoTable' class='landingPage'>
			<tr>
				<td style='width:225px;text-align:left;padding:5px;'> <img src='http://timesheets.hisp.org/timesheets/images/new%20health%20logo-2.jpg' style='width:225px;height:80px;'> </td>
				<td></td>
				<td style='width:180px;text-align:right;padding:5px;'> <img src='http://timesheets.hisp.org/timesheets/images/southafrica_pepfarlogo.jpg' style='width:155px;height:100px;'> </td>
			</tr>
			<tr>
				<td colspan=3 style='padding:10px;'>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:center;'>
					<strong style='font-size:17pt;'>90-90-90 TREATMENT AND RETENTION ACCELERATION<br>QUARTERLY REPORT</strong>
				</td>
			</tr>
			<tr>
				<td colspan=3 style='padding:2px;'>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:center;padding:14px 0 0 0;'>
					<div style='font-size:14pt;font-weight:400' id='ouName'></div>
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:center;padding:6px 0 0 0;'>
					<div style='font-size:14pt;font-weight:400' id='peSummary'></div>
				</td>
			</tr>
            <tr>
				<td colspan=3 style='padding:10px;'>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:center;background-Color:#fff;'>
					<div id='leafMap'></div>
				</td>
			</tr>
			<tr>
				<td colspan=3 style='padding:2px;'>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:center;padding:200px 0 20px 0;'>
					<div style='font-size:10pt;' id='genDetails'></div>
				</td>
			</tr>

		</table>

		<footer></footer>


        <table id='subHeader1' style="">

			<tr>
				<td colspan=3 style='text-align:left;'>
					<strong>&nbsp; 1. &nbsp; BACKGROUND</strong>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					South Africa adopted the UNAIDS 90, 90, 90 targets for HIV in 2014, which aim to ensure that by 2020:<br><br>
					•	 90% of all people living with HIV will know their HIV status<br>
					•	 90% of all people with diagnosed HIV infection will receive sustained antiretroviral therapy<br>
					•	 90% of all people receiving antiretroviral therapy will have viral suppression.<br><br>
					It’s estimated that 7.1 million South Africans are living with HIV, of which 3.8 million are on ART. The National Department of Health is committed to achieving the above targets by addressing the challenges contributing to HIV programme suboptimal performance.
				</td>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
	
			<tr>
				<td colspan=3 style='text-align:left;'>
					<strong>&nbsp; 2. &nbsp; PURPOSE</strong>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;padding: 0 0 0 4px;'>
					The purpose of this report is to improve accountability and ownership at all levels of care through close monitoring, timely remedial actions and rapid mitigation. The indicators listed below must be monitored closely against set targets.
				</td>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					<strong>&nbsp; 3. &nbsp; 90-90-90 HIV cascade</strong>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;padding: 0 0 0 4px;'>
					Cascades are used to track performance towards achieving the 90-90-90 targets. The indicators below are used for this purpose:<br><br>

					1st bar: The total population living with HIV (LHIV). This is generated from the Thembisa estimate model.<br><br>
						
					2nd bar: LHIV who know their status.  It is estimated that 75% of those LHIV in South Africa already know their HIV status. In order to reach the 90% target another 15% of the LHIV population must still be diagnosed<br><br>
						
					3rd bar: LHIV with known status on ART. At least 90% of the LHIV population who know their HIV status must be on ART. The acual number of clients on ART (TROA) is generated from the Provincial integrated webDHIS instances.<br><br>
						
					4th bar: LHIV on ART with VLD at 12 months. 100% of the population that should be on ART must have a viral load done at 12 months. The actual value seen in the green section of the bar is generated from the "viral load done at 12 months rate"  from the cohort of patients who started ART 12-15 months before<br><br>

					5th bar: 90% of expected patients on ART must be virally suppressed. The actual value seen in the green section of the bar is generated from the "viral load suppressed at 12 months rate"  from the cohort of patients who started ART 12-15 months before<br>
				</td>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3>

					<div id='chart1Title'></div>

					<div id="chart1"></div>

				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					<strong>&nbsp; 4. &nbsp; How indicators are monitored</strong>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					The coloured bars provide a quick way of tracking progress made with regard to a particular indicator. The indicators are represented by green, yellow, red and blue bars. The colours mean the following:<br><br>
					<div style="color:#FD3838">Red: Critical</div>
					<div style="color:#FCDC65">Orange: Need to improve</div>
					<div style="color:#6EFD35">Green: The indicator is close to or reached its target value</div>
					<div style="color:#656AFC">Blue: Needs explanation</div><br>
					<!-- Colour ranges for the indicators have been set as follows: -->
					The purpose of this report is to improve accountability and ownership at all levels of care through close monitoring, timely remedial actions and rapid mitigation. The following indicators must be monitored closely against set targets:
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					<!-- <div id='dxList'></div> -->
					Colour ranges for the indicators have been set as follows:<br>
					<table>
						<tr>
							<td>- HIV test done total</td>	<td style="color:#FD3838">below 70 (red)</td><td style="color:#FCDC65">70-89.9 (orange)</td><td style="color:#6EFD35">90-110 (green)</td><td style="color:#656AFC">above 110 (blue)</td>
						</tr>
						<tr>
							<td>- HIV test positive total</td>	<td style="color:#FD3838">below 70 (red)</td><td style="color:#FCDC65">70-89.9 (orange)</td><td style="color:#6EFD35">90-110 (green)</td><td style="color:#656AFC">above 110 (blue)</td>
						</tr>
						<tr>
							<td>- ART client naive start ART total</td>	<td style="color:#FD3838">below 70 (red)</td><td style="color:#FCDC65">70-89.9 (orange)</td><td style="color:#6EFD35">90-110 (green)</td><td style="color:#656AFC">above 110 (blue)</td>
						</tr>
						<tr>
							<td>- ART client remain on ART total</td>	<td style="color:#FD3838">below 70 (red)</td><td style="color:#FCDC65">70-89.9 (orange)</td><td style="color:#6EFD35">90-110 (green)</td><td style="color:#656AFC">above 110 (blue)</td>
						</tr>
						<tr>
							<td>- ART adult viral load done rate at 6 months</td>	<td style="color:#FD3838">below 60 (red)</td><td style="color:#FCDC65">60-74.9 (orange)</td><td style="color:#6EFD35">75-100 (green)</td><td style="color:#656AFC">above 100 (blue)</td>
						</tr>
						<tr>
							<td>- ART adult viral load suppressed rate at 6 months</td>	<td style="color:#FD3838">below 65 (red)</td><td style="color:#FCDC65">65-84.9 (orange)</td><td style="color:#6EFD35">85-100 (green)</td><td style="color:#656AFC">above 100 (blue)</td>
						</tr>
						<tr>
							<td>- ART adult loss to follow-up at 6 months</td>	<td style="color:#6EFD35">below 24 (green)</td><td style="color:#FCDC65">24-30 (orange)</td>	<td style="color:#FD3838">31-60 (red )</td><td style="color:#656AFC">above 60 (blue)</td>
						</tr>

					</table>
				</td>
			</tr>
			<tr>
				<td colspan=3 style='padding:2px;'>
					&nbsp;
				</td>
			</tr>
		</table>

		<footer></footer>

		<table id='subHeader2' style="">
	
			<tr>
				<td colspan=3 style='text-align:left;'>
					<strong>&nbsp; 5. &nbsp;Summary</strong>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;The following tables provide a summary of progress for the current financial year.
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>

				<div id="" style="padding:0">

						<div id='table1Title' class='tableTitle'></div>

						<table border=0 cellpadding=0 cellspacing=0 style='min-width:75%;' id='tblMaster' class='MainTbl rounded'>
							<thead>
								<tr>
									<th colspan=1 rowspan=2 class='labelHeader' style='border-left:0;'>{PLACEHOLDER}</th>
									<th colspan=1 rowspan=2 class='labelHeader' id='1_peFprev'></th>
									<th colspan=1 rowspan=2 class='labelHeader' id='1_peFtarget'></th>
									<th colspan=4 rowspan=1 class='labelHeader' id='1_FYspan'></th>
									<th colspan=1 rowspan=2 class='labelHeader' id='1_peQTRtarget'></th>
									<th colspan=1 rowspan=2 class='labelquarterName' id='1_peQ2'></th>
									<th colspan=1 rowspan=2 class='labelquarterName' id='1_peQ3'></th>
									<th colspan=1 rowspan=2 class='labelquarterName' id='1_peQ4'></th>
									<th colspan=1 rowspan=2 class='labelquarterName' id='1_peQ1'></th>
						
								</tr>
								<tr>
									<th colspan=1 class='labelHeader' id='1_peFYTDtarget'></th>
									<th colspan=1 class='labelHeader' id='1_peFYTDactual'></th>
									<th colspan=1 class='labelHeader' id='1_peFYTDgap'></th>
									<th colspan=1 class='labelHeader' id='1_peFYTDprogress'></th>
								</tr>
							</thead>
						</table>
						
						</div>
					</td>
				</tr>
				<tr>
					<td colspan=3>
						&nbsp;
					</td>
				</tr>
				<tr>
					<td colspan=3 style='text-align:left;'>
						<strong>&nbsp; 6. &nbsp;Ranking Per Indicator</strong>
				</tr>
				<tr>
					<td colspan=3>
						&nbsp;
					</td>
				</tr>
				<tr>
					<td colspan=3>
						&nbsp;Organisation units are ranked from those with the largest gap to those with the smallest gap in relation to the targets for the individual indicators.
					</td>
				</tr>
				<tr>
					<td colspan=3 style='text-align:left;'>
						<div id='rankedItems' class='tableTitle'></div>
					</td>
				</tr>
		</table>

	</div>


<!-- <input type="button" value="Export to Excel" id="exceldownloadbutton" name="exceldownloadbutton" onclick="javascript:fnExcelReport()" class="no-print" style="display:none;width:140px;position:absolute;left:306px;top:65px;"> -->

 <script language=javascript>

	var quarters = ['Jan-Mar', 'Apr-Jun', 'Jul-Sep', 'Oct-Dec'];
	var dxCore = 'KnQn2N452bE,Bmo4lk1FhgP,fG0NDp9ZcQh,mH17opU6Ivq,YrrIYRXd82h,NsrFeZdWd14,Og44c6zMLLT'; //S6BlQpoZVhQ: TB screening REMOVED Temporarily (2018-02-09); replaced (2018-03-20) gOOE6omxMyL,IsqRJtrTAP6,ePxyv7IJofg
	var dxCoreSentiment = '1,1,1,1,1,1,-1';
	var dxCoreArr = dxCore.split(',');
	var dxCoreSentimentArr = dxCoreSentiment.split(',')
	var dxCat = 'wyZ6KAmjZeD,mLVlvjLwl9q';
	var dxOffset = ''; /*gOOE6omxMyL,IsqRJtrTAP6,ePxyv7IJofg*/
	var dxSingleTarget = 'Og44c6zMLLT,YrrIYRXd82h,NsrFeZdWd14'; 
	var dxCoreCat = '';
	var lblCat = 'Actual,Target';
	var dxMMendOfQtr = 'mH17opU6Ivq';
	var peQTRrangeMMending = '';
	var peQTRrange = '';
	var peQTRrangeEnd = '';
	var peQTRlabelEnd = '';
	var peQTRprevYmmRangeEnd = '';
	var peQTRcurrYRangeEnd = '';
	var peQTRcurrYmmRangeEnd = '';
	var peQTRrangeAct = '';
	var dxSummaryCounter = [];

	var peQcurr = parseInt(pe.split('Q')[1]); //parseInt(pe.substring(4,6));
	var peFcurr = parseInt(pe.split('Q')[0]); //parseInt(pe.substring(0,4));

	if (peQcurr < 2){
		peFcurr = (peFcurr-1);
	}

	var peFprev = (peFcurr-1); //parseInt(((parseInt(peQcurr)<4) ? (peFcurr-1) : peFcurr));
	var peFcurrSuff = parseInt(peFcurr.toString().substring(2,4));
	var peFprevSuff = parseInt(peFprev.toString().substring(2,4));

	var peFYcurr = (peFcurr+'April');
	var peFYprev = (peFprev+'April');

	var peFYprevJul = (peFprev+'July');//dxSingleTarget.indexOf(dxCoreArr[p])

	if (dxMMendOfQtr.length > 0) {
		peQTRprevYmmRangeEnd = (peFcurr + '03');
		peQTRcurrYmmRangeEnd = ((peFcurr+1) + '03');
	}

	peQTRcurrYRangeEnd = ((peFcurr+1) + 'Q1');



    /* MAP START */
    var g_map = new L.map('leafMap', { zoomControl:false, renderer: L.svg({ padding: 100 }) }).setView([-28.5, 26], 6);
	var g_baseMapLayerOpacity = 0.5;

	var Esri_WorldGrayCanvas = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {opacity: g_baseMapLayerOpacity, attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',maxZoom: 16});
	var Esri_WorldShadedRelief = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {opacity: g_baseMapLayerOpacity, attribution: 'Tiles &copy; Esri &mdash; Source: Esri',	maxZoom: 13});
	var Open_StreetMap = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',});
	var HikeBike_HikeBike = L.tileLayer('http://{s}.tiles.wmflabs.org/hikebike/{z}/{x}/{y}.png', {opacity: g_baseMapLayerOpacity, maxZoom: 19,attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});

	g_baseMapCollection = {
		"PRINT: Esri.WorldGrayCanvas": Esri_WorldGrayCanvas,
		"PRINT: Esri.WorldShadedRelief": Esri_WorldShadedRelief,
		"PRINT: StreetMap": Open_StreetMap,
		"HikeBike":HikeBike_HikeBike
	};

	var layerControl = L.control.layers(g_baseMapCollection, null, {position:'bottomright', opacitySlider: true}).addTo(g_map);
	var g_baseLayer = Esri_WorldGrayCanvas.addTo(g_map);

	/* MAP END */

	document.getElementById('1_peFprev').innerHTML = (peFprev + '/' + peFcurrSuff + '<br>Baseline');
	document.getElementById('1_peFtarget').innerHTML = (peFcurr + '/' + ((peFcurrSuff)+1) + '<br>Target');

	document.getElementById('1_FYspan').innerHTML = ('YTD ' + peFcurr + '/' + ((peFcurrSuff)+1) + '');

	document.getElementById('1_peFYTDtarget').innerHTML = ('Target');
	document.getElementById('1_peFYTDactual').innerHTML = ('Actual');
	document.getElementById('1_peFYTDgap').innerHTML = ('Gap');
	document.getElementById('1_peFYTDprogress').innerHTML = ('Progress');

	document.getElementById('1_peQTRtarget').innerHTML = (peFcurr + '/' + ((peFcurrSuff)+1) + '<br>Quarterly<br>Target');

	for (var p = 2; p <= 4; p++){
		document.getElementById('1_peQ'+p).innerHTML = ((quarters[p-1]).toString() +'<br>'+peFcurrSuff);
		if ( (p > peQcurr) && (peQcurr > 1) ){
			document.getElementById('1_peQ'+p).style.display='none';
		} else {
			peQTRrange += ((peFcurr+'Q'+p)+';');
			peQTRrangeAct += (getPeriodPair(peFcurr+'Q'+p)+';');
			peQTRlabelEnd = ((quarters[p-1]).toString()+'<br>'+peFcurrSuff);
			peQTRrangeEnd = (peFcurr+'Q'+p);
			peQTRrangeMMending += getPeriodPairEndMM(peFcurr+'Q'+p)+';';
		}
	}
	for (var p = 1; p <= 1; p++){
		document.getElementById('1_peQ'+p).innerHTML = ((quarters[p-1]).toString()+'<br>'+(peFcurrSuff+1));
		if (peQcurr > p){
			document.getElementById('1_peQ'+p).style.display='none';
		} else {
			peQTRrange += ((peFcurr+1)+'Q'+p+';');
			peQTRrangeAct += (getPeriodPair((peFcurr+1)+'Q'+p)+';');
			peQTRlabelEnd = ((quarters[p-1]).toString()+'<br>'+(peFcurrSuff+1));
			peQTRrangeEnd = ((peFcurrSuff+1)+'Q'+p);
			peQTRrangeMMending += getPeriodPairEndMM((peFcurr+1)+'Q'+p)+';';
		}
	}

	var template1 = document.getElementById('tblMaster').outerHTML.replace('MainTbl','SecondaryTbl');

	document.getElementById('tblMaster').outerHTML = document.getElementById('tblMaster').outerHTML.replace('{PLACEHOLDER}',dhis2.report.organisationUnit.name)

	for (var p = 2; p <= 4; p++){
		document.getElementById('1_peQ'+p).innerHTML = ((quarters[p-1]).toString()+'<br>'+peFcurrSuff);
	}
	for (var p = 1; p <= 1; p++){
		document.getElementById('1_peQ'+p).innerHTML = ((quarters[p-1]).toString()+'<br>'+(peFcurrSuff+1));
	}

	var myYTDCALCvals = [];

	//URL for Dx Core List
	var sDxCore = ('../api/dataElements.json?filter=id:in:['+dxCore+']&fields=id,name,shortName,displayName');

	 $.ajax({
		url: sDxCore,
		error: function (xhr, ajaxOptions, thrownError) {
			console.log('error: Data Element Lookup');
		},
		success : function(dataDE){

			var ArrDx = dxCore.split(',');
			var tbl1 = document.getElementById('tblMaster');
			var tbody = document.createElement('tbody');
			tbl1.appendChild(tbody);

			var ArrPEmmEnd = peQTRrangeMMending.substring(peQTRrangeMMending,peQTRrangeMMending.length-1).split(';');

			//for (var p = 0; p < dataDE.dataElements.length; p++){
			for (var p = 0; p < dxCoreArr.length; p++){

				dxSummaryCounter.push ( { dx: dxCoreArr[p], counter: 0, missing: 0, colorMatch: { "blue": 0, "blue_progress":0, "green": 0, "green_progress":0, "orange": 0, "orange_progress":0, "red": 0, "red_progress":0 } } );

				myYTDCALCvals.push ({
					ou: ou,
					dx: dxCoreArr[p],
					baseline: 0,
					FYtarget: 0,
					YTDtarget: 0,
					YTDactual: 0,
					YTDgapNum: 0,
					YTDgapPer: 0,
					CALCtarget: 0,
					CALCactual: 0,
					GrandTotAll: 0,
					QTR02: 0,
					QTR03: 0,
					QTR04: 0,
					QTR01: 0,
					LASTtarget: 0
				});

				if (dxCoreArr[p] == 'YrrIYRXd82h'){

					var iCols = (tr.childNodes.length + 1);

					var tr = document.createElement('tr');
					tr.setAttribute("id",dxCoreArr[p]+'_'+ou+'_rowHeader');
					tbody.appendChild(tr);

					var td = document.createElement('td');
					td.setAttribute("style",'font-style:italic;background-Color:#f5f5f5;padding:3px;border-bottom:1px solid #000;width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;');
					td.setAttribute("colspan",iCols);
					tr.appendChild(td);

					td.innerText = 'Generated from patient cohort starting treatment 6 - 9 months before';

				}

				var tr = document.createElement('tr');
				tr.setAttribute("id",dxCoreArr[p]+'_'+ou+'_row');
				tbody.appendChild(tr);

				var td = document.createElement('td');
				td.setAttribute("style",'padding:3px;border-bottom:1px solid #000;width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;');
				td.setAttribute("id",'1_'+dxCoreArr[p]+'_1');
				tr.appendChild(td);

				//td.innerText = (dataDE.dataElements[p].name).replace('TRAP_','');
				td.innerText = (getElementName(dataDE,dxCoreArr[p])).replace('TRAP_','');

				//document.getElementById('dxList').innerHTML += ('<div style="padding:2px 0 2px 2px"> • ' + (getElementName(dataDE,dxCoreArr[p])).replace('TRAP_','')+'</div>')

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				//td.setAttribute("id",'1_'+dxCoreArr[p]+'_1');
				if (dxSingleTarget.indexOf(dxCoreArr[p]) < 0){
					td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+peFYprev);
				} else {
					td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+peFYprevJul);
				}
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				//td.setAttribute("id",'1_'+dxCoreArr[p]+'_2');
				td.setAttribute("id",dxCoreArr[p]+'.mLVlvjLwl9q_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				//td.setAttribute("storedValue",'');
				td.setAttribute("id",dxCoreArr[p]+'.YTDtarget_'+ou+'_'+peFYcurr );
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				//td.setAttribute("storedValue",'');
				td.setAttribute("id",dxCoreArr[p]+'.YTDactual_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				td.setAttribute("id",dxCoreArr[p]+'.DifferenceGap_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				//td.setAttribute("class",'cellNumeric');
				//td.setAttribute("id",'1_'+dxCoreArr[p]+'_6');
				td.setAttribute("id",dxCoreArr[p]+'.DifferencePercentage_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				td.setAttribute("id",dxCoreArr[p]+'.mLVlvjLwl9q_'+ou+'_'+peQTRrange.split(';')[0]);
				tr.appendChild(td);

				for (var r = 2; r <= 4; r++){
					if ( (r <= peQcurr) || (peQcurr == 1) ){
						var td = document.createElement('td');
						td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
						td.setAttribute("class",'cellNumeric');
						//td.setAttribute("id",'1_'+dxCoreArr[p]+'_QTR_'+peFcurr+paddNumeric(r,2));
						if (dxOffset.indexOf(dxCoreArr[p]) >= 0 ){
							td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+getPeriodPair(peFcurr+'Q'+r));
						} else {
							if (dxMMendOfQtr.indexOf(dxCoreArr[p]) >= 0 ){
								td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+getPeriodPairEndMM(peFcurr+'Q'+r));
							} else {
								td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+(peFcurr+'Q'+r));
							}
						}
						tr.appendChild(td);
					}
				}
				for (var r = 1; r <= 1; r++){
					if ( (r >= peQcurr)  ){
						var td = document.createElement('td');
						td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
						td.setAttribute("class",'cellNumeric');
						//td.setAttribute("id",'1_'+dxCoreArr[p]+'_QTR_'+(peFcurr+1)+paddNumeric(r,2));
						if (dxOffset.indexOf(dxCoreArr[p]) >= 0 ){
							td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+getPeriodPair((peFcurr+1)+'Q'+r));
						} else {
							if (dxMMendOfQtr.indexOf(dxCoreArr[p]) >= 0 ){
								td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+getPeriodPairEndMM((peFcurr+1)+'Q'+r));
							} else {
								td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+((peFcurr+1)+'Q'+r));
							}
						}
						tr.appendChild(td);
					}
				}

			}

			var dv = document.createElement('div');
			dv.setAttribute('class','tableTitle');
			dv.innerText = 'Table 1. Quarterly Summary for '+dhis2.report.organisationUnit.name+' (F' + peFcurr + ', quarter [' + peQTRlabelEnd.replace('<br>',' ') + '])';
			document.getElementById('table1Title').appendChild(dv);

			var dxArrCore = dxCore.split(',')
			var dxArrCat = dxCat.split(',')

			for (var n = 0; n < dxArrCore.length; n++){
				for (var o = 0; o < dxArrCat.length; o++){
					dxCoreCat += (dxArrCore[n]+'.'+dxArrCat[o]+';');
				}
			}

			dxCoreCat = dxCoreCat.substring(dxCoreCat,dxCoreCat.length-1);

			//URL for parent-OU 
			var sOU = ('../api/organisationUnits/' + ou + '.json?fields=id,name,displayName,displayShortName,level,children[id,name,displayName,displayShortName,level]');

			$.ajax({
				url: sOU,
				error: function (xhr, ajaxOptions, thrownError) {
					console.log('error: Data Element Lookup');
				},
				success : function(dataOU){

					var OUchildren = '';

					for (var p = 0; p < dataOU.children.length; p++){
						OUchildren += (dataOU.children[p].id + ';');
					}

					OUchildren = OUchildren.substring(OUchildren,OUchildren.length-1);

					//for (var n = 0; n < dataDE.dataElements.length; n++){
					for (var n = 0; n < dxCoreArr.length; n++){

						var dv1 = document.createElement('div');
						dv1.setAttribute('class','tableTitle');
						dv1.innerText = 'Table '+(n+2)+'. '+(getElementName(dataDE,dxCoreArr[n])).replace('TRAP_','') + ' ('+dhis2.report.organisationUnit.name+', quarter [' + peQTRlabelEnd.replace('<br>',' ') + '])';
						//dv.appendChild(dv1);
						document.getElementById('rankedItems').appendChild(dv1);

						var dv = document.createElement('div');
						dv.setAttribute('id','dv_'+dxCoreArr[n]);
						dv.setAttribute('style','padding:8px 0 8px 0;');
						document.getElementById('rankedItems').appendChild(dv);

						dv.innerHTML = (template1.replace('tblMaster','tblDx_'+dxCoreArr[n]));
						dv.innerHTML = (dv.innerHTML).replace('{PLACEHOLDER}',(getElementName(dataDE,dxCoreArr[n])).replace('TRAP_','')).replace('TRAP_','');

						var tbl1 = document.getElementById('tblDx_'+dxCoreArr[n]);
						var tbody = document.createElement('tbody');
						tbl1.appendChild(tbody);

						for (var p = 0; p < dataOU.children.length; p++){

							myYTDCALCvals.push ({
								ou: dataOU.children[p].id,
								dx: dxCoreArr[n],
								baseline: 0,
								FYtarget: 0,
								YTDtarget: 0,
								YTDactual: 0,
								YTDgapNum: 0,
								YTDgapPer: 0,
								CALCtarget: 0,
								CALCactual: 0,
								GrandTotAll: 0,
								QTR02: 0,
								QTR03: 0,
								QTR04: 0,
								QTR01: 0,
								LASTtarget: 0
							});

							var tr = document.createElement('tr');
							tr.setAttribute("id",dxCoreArr[n]+'_'+dataOU.children[p].id+'_row');
							tbody.appendChild(tr);

							var td = document.createElement('td');
							td.setAttribute("style",'padding:3px;border-bottom:1px solid #000;width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;');
							td.setAttribute("id",dxCoreArr[n]+'_'+dataOU.children[p].id+'_0');
							tr.appendChild(td);

							//td.innerText = (dataOU.children[p].name);
							td.innerHTML = '<a href="generateHtmlReport.action?uid='+repUID+'&pe='+pe+'&ou='+dataOU.children[p].id+'" style="color:#000">' + (dataOU.children[p].name) + '</a>';

							

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							
							if (dxSingleTarget.indexOf(dxCoreArr[n]) < 0){
								td.setAttribute("id",dxCoreArr[n]+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+peFYprev);
							} else {
								td.setAttribute("id",dxCoreArr[n]+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+peFYprevJul);
							}
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dxCoreArr[n]+'.mLVlvjLwl9q_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dxCoreArr[n]+'.YTDtarget_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dxCoreArr[n]+'.YTDactual_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dxCoreArr[n]+'.DifferenceGap_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							//td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dxCoreArr[n]+'.DifferencePercentage_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dxCoreArr[n]+'.mLVlvjLwl9q_'+dataOU.children[p].id+'_'+peQTRrange.split(';')[0]);
							tr.appendChild(td);

							for (var r = 2; r <= 4; r++){
								if ( (r <= peQcurr) || (peQcurr == 1) ){
									var td = document.createElement('td');
									td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
									td.setAttribute("class",'cellNumeric');
									if (dxOffset.indexOf(dxCoreArr[n]) >= 0 ){
										td.setAttribute("id",dxCoreArr[n]+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+getPeriodPair(peFcurr+'Q'+r));
									} else {
										if (dxMMendOfQtr.indexOf(dxCoreArr[n]) >= 0 ){
											td.setAttribute("id",dxCoreArr[n]+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+getPeriodPairEndMM(peFcurr+'Q'+r));
										} else {
											td.setAttribute("id",dxCoreArr[n]+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+(peFcurr+'Q'+r));
										}
									}
									tr.appendChild(td);
								}
							}
							for (var r = 1; r <= 1; r++){
								if ( (r >= peQcurr)  ){
									var td = document.createElement('td');
									td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
									td.setAttribute("class",'cellNumeric');
									if (dxOffset.indexOf(dxCoreArr[n]) >= 0 ){
										td.setAttribute("id",dxCoreArr[n]+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+getPeriodPair((peFcurr+1)+'Q'+r));
									} else {
										if (dxMMendOfQtr.indexOf(dxCoreArr[n]) >= 0 ){
											td.setAttribute("id",dxCoreArr[n]+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+getPeriodPairEndMM(((peFcurr+1)+'Q'+r)));
										} else {
											td.setAttribute("id",dxCoreArr[n]+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+((peFcurr+1)+'Q'+r));
										}
									}
									tr.appendChild(td);
								}
							}

						}

					}

					var sDataGet = '../api/26/analytics.json?dimension=dx:'+dxCore.replace(',',';')+';'+dxCoreCat+'&dimension=pe:'+peQTRrangeMMending+peQTRrangeAct+peQTRcurrYRangeEnd+';'+( (peQTRprevYmmRangeEnd.length > 0) ? (peQTRprevYmmRangeEnd + ';' + peQTRcurrYmmRangeEnd + ';') : '' )+peQTRrange+peFYcurr+';'+peFYprev+';'+peFYprevJul+'&dimension=ou:'+ou+';'+OUchildren+'&displayProperty=NAME&outputIdScheme=UID';
					console.log(sDataGet);

					$.ajax({
						url: sDataGet,
						error: function (xhr, ajaxOptions, thrownError) {
							console.log('error: getting report data values');
						},
						success : function(dataVal){

							var comboRESULTALL = [];

							for (var i = 0; i < dataVal.rows.length; i++){

								var myRowID = (dataVal.rows[i][0] + '_' + dataVal.rows[i][2] + '_' + dataVal.rows[i][1]);
								var myValue = dataVal.rows[i][3];

								comboRESULTALL.push ({ id: myRowID, value: myValue });

								try {
									document.getElementById(myRowID).innerText = formatNumber(parseFloat(myValue).toFixed(1).toString().replace('.0',''));
								}
								catch(err) {
									//console.log('No match: '+myRowID +': ['+myValue+']')
								}

							}

							for (var a = 0; a < myYTDCALCvals.length; a++){

								for (var i = 0; i < comboRESULTALL.length; i++){

									// DX and OU match
									if ( ( (comboRESULTALL[i].id).indexOf(myYTDCALCvals[a].dx) >= 0) && ( (comboRESULTALL[i].id).indexOf(myYTDCALCvals[a].ou) >= 0) ){

										if ( ( (comboRESULTALL[i].id).indexOf(peFYprev) >= 0) && ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) < 0) && ( (dxSingleTarget).indexOf(myYTDCALCvals[a].dx) < 0) ) {
											myYTDCALCvals[a].baseline = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
										} else {
											if ( ( (comboRESULTALL[i].id).indexOf(peFYprevJul) >= 0) && ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) < 0) && ( (dxSingleTarget).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].baseline = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
											// PE match of Prev-Year-End-QTR value for End-Of-Month element
											if ( ( (comboRESULTALL[i].id).indexOf(peQTRprevYmmRangeEnd) >= 0) && ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].baseline = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
										}

										// YTD target
										if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && ( (comboRESULTALL[i].id).indexOf(peFYcurr) >= 0) && ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) < 0) ) {
											myYTDCALCvals[a].FYtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
										} else {
											// PE match of Current-Range-End-QTR value for End-Of-Month element
											if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && ( (comboRESULTALL[i].id).indexOf(peQTRcurrYmmRangeEnd ) >= 0) && ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].FYtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
											// PE match of Current-Range-End-QTR value for End-Of-Month element
											if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && ( (comboRESULTALL[i].id).indexOf(ArrPEmmEnd[ArrPEmmEnd.length-1] ) >= 0) && ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].YTDtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
											// PE match of Current-Range-End-QTR value for End-Of-Month element
											if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && ( (comboRESULTALL[i].id).indexOf(getPeriodPair(ArrPEmmEnd[ArrPEmmEnd.length-1]) ) >= 0) && ( (dxOffset).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].YTDtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												//myYTDCALCvals[a].LASTtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
											if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && ( (comboRESULTALL[i].id).indexOf(getPeriodPair(ArrPEmmEnd[ArrPEmmEnd.length-1]) ) >= 0) && ( (dxSingleTarget).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].YTDtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												//myYTDCALCvals[a].LASTtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
										}

										// YTD actual
										if ( ( (comboRESULTALL[i].id).indexOf('wyZ6KAmjZeD') >= 0) && ( (comboRESULTALL[i].id).indexOf(peFYcurr) >= 0) && ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) < 0) ) {
											myYTDCALCvals[a].YTDactual = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
										} else {
											// PE match of Current-Range-End-QTR value for End-Of-Month element
											if ( ( (comboRESULTALL[i].id).indexOf('wyZ6KAmjZeD') >= 0) && ( (comboRESULTALL[i].id).indexOf(ArrPEmmEnd[ArrPEmmEnd.length-1]) >= 0) && ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].YTDactual = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												myYTDCALCvals[a].CALCactual = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
										}

										var PEarr = peQTRrange.substring(peQTRrange,peQTRrange.length-1).split(';')

										for (var p = 0; p < PEarr.length; p++){
											if ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) < 0){
												// YTD CALC of TARGET
												if ( ( (comboRESULTALL[i].id).indexOf('.mLVlvjLwl9q') >= 0) && ((comboRESULTALL[i].id).indexOf(PEarr[p]) >= 0) && ( (dxOffset).indexOf(myYTDCALCvals[a].dx) < 0) && ( (dxSingleTarget).indexOf(myYTDCALCvals[a].dx) < 0) ) {
													myYTDCALCvals[a].YTDtarget += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												}
												/*if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && (p == (PEarr.length-1)) && ( (comboRESULTALL[i].id).indexOf(PEarr[p]) >= 0) && ( (dxOffset).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
													//console.log(PEarr[p] + ': ' + comboRESULTALL[i].id + ' = ' + comboRESULTALL[i].value);
													myYTDCALCvals[a].YTDtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												}*/
												if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && (p == (PEarr.length-1)) && ( (comboRESULTALL[i].id).indexOf(PEarr[p]) >= 0) && ( (dxSingleTarget).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
													//console.log(PEarr[p] + ': ' + comboRESULTALL[i].id + ' = ' + comboRESULTALL[i].value);
													myYTDCALCvals[a].YTDtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												}
											}
											// YTD CALC of TARGET
											if ( ( (comboRESULTALL[i].id).indexOf('.mLVlvjLwl9q') >= 0) && ((comboRESULTALL[i].id).indexOf(PEarr[p]) >= 0) ) {
												myYTDCALCvals[a].CALCtarget += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
											// ACTUAL
											if ( ( (comboRESULTALL[i].id).indexOf('.wyZ6KAmjZeD') >= 0) && ((comboRESULTALL[i].id).indexOf(getPeriodPair(PEarr[p])) >= 0) && (dxSingleTarget.indexOf(myYTDCALCvals[a].dx) < 0) ) {
												myYTDCALCvals[a].CALCactual += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											} else {
												if ( ( (comboRESULTALL[i].id).indexOf('.wyZ6KAmjZeD') >= 0) && ((comboRESULTALL[i].id).indexOf((PEarr[p])) >= 0) && (dxSingleTarget.indexOf(myYTDCALCvals[a].dx) >= 0) ) {
													myYTDCALCvals[a].CALCactual += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												}
											}

										}

										myYTDCALCvals[a].GrandTotAll += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);

									}

								}

							}


							for (var a = 0; a < myYTDCALCvals.length; a++){

								if (dxSingleTarget.indexOf(myYTDCALCvals[a].dx) < 0){
									document.getElementById(myYTDCALCvals[a].dx+'.wyZ6KAmjZeD_'+myYTDCALCvals[a].ou+'_'+peFYprev).innerText = formatNumber( parseFloat(myYTDCALCvals[a].baseline) );
								} else {
									document.getElementById(myYTDCALCvals[a].dx+'.wyZ6KAmjZeD_'+myYTDCALCvals[a].ou+'_'+peFYprevJul).innerText = formatNumber( parseFloat(myYTDCALCvals[a].baseline) );
								}
								document.getElementById(myYTDCALCvals[a].dx+'.mLVlvjLwl9q_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].FYtarget) );
								document.getElementById(myYTDCALCvals[a].dx+'.YTDtarget_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].YTDtarget) ); //formatNumber( ( (dxOffset.indexOf(myYTDCALCvals[a].dx)>=0) ? parseFloat(myYTDCALCvals[a].FYtarget) : parseFloat(myYTDCALCvals[a].YTDtarget) )  );

								if ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) >= 0){
									// do nothing
								} else {
									if ( ( (dxOffset).indexOf(myYTDCALCvals[a].dx) >= 0) || ( (dxSingleTarget).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
										myYTDCALCvals[a].YTDactual = parseFloat(parseFloat(myYTDCALCvals[a].CALCactual) / (PEarr.length)).toFixed(1);
									} else {
										/*if ( (dxSingleTarget).indexOf(myYTDCALCvals[a].dx) >= 0){
											myYTDCALCvals[a].YTDactual = parseFloat(parseFloat(myYTDCALCvals[a].CALCactual) / (PEarr.length)).toFixed(1);
										}*/
										// do nothing
									}
								}

								if (myYTDCALCvals[a].YTDtarget > 0) {
									if (( (dxOffset).indexOf(myYTDCALCvals[a].dx) >= 0) || ( (dxSingleTarget).indexOf(myYTDCALCvals[a].dx) >= 0)){
										var iW = parseFloat(parseFloat(myYTDCALCvals[a].YTDactual) / parseFloat(100) * 100 ).toFixed(0);
										document.getElementById(myYTDCALCvals[a].dx+'.DifferencePercentage_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerHTML = '<div class="perfBar"><div class="cellNumeric" style="padding:4px 4px 0px 4px">' + formatNumber( (parseFloat(myYTDCALCvals[a].YTDactual) / parseFloat(100) * 100 ).toFixed(0)) + '%' + '</div><div style="position:relative;left:0;top:0;width:' + ( (parseInt(iW) > 0) ? ((parseInt(iW) > 500) ? 500 : parseInt(iW)) : 0)  + '%;height:4px;border-top:1px solid #f5f5f5;border-right:1px solid #f5f5f5;background-Color:'+getBackgroundPerformanceColor(iW,myYTDCALCvals[a].dx,(myYTDCALCvals[a].ou==ou))+';">&nbsp;</div></div>';
									} else {
										var iW = parseFloat(parseFloat(myYTDCALCvals[a].YTDactual) / parseFloat(myYTDCALCvals[a].YTDtarget) * 100 ).toFixed(0);
										document.getElementById(myYTDCALCvals[a].dx+'.DifferencePercentage_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerHTML = '<div class="perfBar"><div class="cellNumeric" style="padding:4px 4px 0px 4px">' + formatNumber( (parseFloat(myYTDCALCvals[a].YTDactual) / parseFloat(myYTDCALCvals[a].YTDtarget) * 100 ).toFixed(0)) + '%' + '</div><div style="position:relative;left:0;top:0;width:' + ( (parseInt(iW) > 0) ? ((parseInt(iW) > 500) ? 500 : parseInt(iW)) : 0)  + '%;height:4px;border-top:1px solid #f5f5f5;border-right:1px solid #f5f5f5;background-Color:'+getBackgroundPerformanceColor(iW,myYTDCALCvals[a].dx,(myYTDCALCvals[a].ou==ou))+';">&nbsp;</div></div>';
									}
								}

								if ( (dxMMendOfQtr).indexOf(myYTDCALCvals[a].dx) >= 0){
									document.getElementById(myYTDCALCvals[a].dx+'.mLVlvjLwl9q_'+myYTDCALCvals[a].ou+'_'+peQTRrange.split(';')[0]).innerHTML = formatNumber( parseFloat(myYTDCALCvals[a].YTDtarget) );
									document.getElementById(myYTDCALCvals[a].dx+'.YTDactual_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].YTDactual) );
									document.getElementById(myYTDCALCvals[a].dx+'.DifferenceGap_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( (parseFloat(myYTDCALCvals[a].YTDtarget) - parseFloat(myYTDCALCvals[a].YTDactual)).toFixed(0) );
								} else {

									if ( (dxOffset).indexOf(myYTDCALCvals[a].dx) >= 0){
										document.getElementById(myYTDCALCvals[a].dx+'.YTDactual_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(parseFloat(myYTDCALCvals[a].CALCactual) / (PEarr.length)).toFixed(1) );
										document.getElementById(myYTDCALCvals[a].dx+'.DifferenceGap_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( (parseFloat(myYTDCALCvals[a].YTDtarget) - parseFloat(parseFloat(myYTDCALCvals[a].CALCactual) / (PEarr.length))).toFixed(0) );

									} else {
										document.getElementById(myYTDCALCvals[a].dx+'.YTDactual_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].YTDactual).toFixed(1) );
										document.getElementById(myYTDCALCvals[a].dx+'.DifferenceGap_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( (parseFloat(myYTDCALCvals[a].YTDtarget) - parseFloat(myYTDCALCvals[a].YTDactual)).toFixed(0) );

									}
								}



								if (myYTDCALCvals[a].GrandTotAll == 0) { 
									if (myYTDCALCvals[a].ou != ou){
										incrDxSummaryMissing(myYTDCALCvals[a].dx);
									}
									document.getElementById(myYTDCALCvals[a].dx+'_'+myYTDCALCvals[a].ou+'_row').style.display = 'none';
								}

							}

							document.getElementById('ouName').innerText = dhis2.report.organisationUnit.name;
							document.getElementById('peSummary').innerText = ('Financial year ' + peFcurr + '/' + ((peFcurrSuff)+1) + ', quarter ending ' + peQTRlabelEnd.replace('<br>',' '));
							document.getElementById('genDetails').innerHTML = '<i>report created </i>' + todayDate();
							document.getElementById("logoTable").style.width = (document.getElementById("tblMaster").offsetWidth + 'px');

							setTimeout(function () { loadChart(); }, 100);
							setTimeout(function () { loadMapFrame(); }, 200);

							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[0], 5); }, 1000 ) ;
							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[1], 5); }, 1100 ) ;
							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[2], 5); }, 1200 ) ;
							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[3], 5); }, 1300 ) ;
							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[4], 5); }, 1400 ) ;
							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[5], 5); }, 1500 ) ;
							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[6], 5); }, 1600 ) ;


							for (var n = 0; n < dxCoreArr.length; n++){

								var tbl = document.createElement('table');
								tbl.setAttribute("style","");
								document.getElementById('dv_'+dxCoreArr[n]).appendChild(tbl);

								var tr = document.createElement('tr');
								tbl.appendChild(tr);
								var td = document.createElement('td');
								td.setAttribute("style",'padding:3px;border-bottom:1px solid #fff;width:400px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;');
								tr.appendChild(td);

								var sInner = 'Out of ' + dxSummaryCounter[n].counter + ' participating orgunits:<br>'
								td.innerHTML = sInner;

								if (dxSummaryCounter[n].colorMatch['red'] > 0){

									var tr = document.createElement('tr');
									tbl.appendChild(tr);
									var td = document.createElement('td');
									td.setAttribute("style",'padding:0 0 0 4px;border-bottom:1px solid #fff;width:500px;height:14px;');
									tr.appendChild(td);

									sInner = '<div style="padding:0"> • '+parseFloat(dxSummaryCounter[n].colorMatch['red']/dxSummaryCounter[n].counter * 100).toFixed(0)+'% ('+dxSummaryCounter[n].colorMatch['red']+') scored in <span style="background-Color:#FC6565;color:#fff;width:50px;">[RED]</span> group with an average YTD progress score of [' + parseFloat(dxSummaryCounter[n].colorMatch['red_progress']/(dxSummaryCounter[n].colorMatch['red'])).toFixed(1) + '%];</div>';
									td.innerHTML = sInner;

								}

								if (dxSummaryCounter[n].colorMatch['orange'] > 0){

									var tr = document.createElement('tr');
									tbl.appendChild(tr);
									var td = document.createElement('td');
									td.setAttribute("style",'padding:0 0 0 4px;border-bottom:1px solid #fff;width:500px;height:14px;');
									tr.appendChild(td);

									sInner = '<div style="padding:0"> • '+parseFloat(dxSummaryCounter[n].colorMatch['orange']/dxSummaryCounter[n].counter * 100).toFixed(0)+'% ('+dxSummaryCounter[n].colorMatch['orange']+') scored in <span style="background-Color:#FCDC65;color:#fff;width:50px;">[ORANGE]</span> group with an average YTD progress score of [' + parseFloat(dxSummaryCounter[n].colorMatch['orange_progress']/(dxSummaryCounter[n].colorMatch['orange'])).toFixed(1) + '%];</div>';
									td.innerHTML = sInner;

								}

								if (dxSummaryCounter[n].colorMatch['green'] > 0){

									var tr = document.createElement('tr');
									tbl.appendChild(tr);
									var td = document.createElement('td');
									td.setAttribute("style",'padding:0 0 0 4px;border-bottom:1px solid #fff;width:500px;height:14px;');
									tr.appendChild(td);

									sInner = '<div style="padding:0"> • '+parseFloat(dxSummaryCounter[n].colorMatch['green']/dxSummaryCounter[n].counter * 100).toFixed(0)+'% ('+dxSummaryCounter[n].colorMatch['green']+') scored in <span style="background-Color:#90FC65;color:#fff;width:50px;">[GREEN]</span> group with an average YTD progress score of [' + parseFloat(dxSummaryCounter[n].colorMatch['green_progress']/(dxSummaryCounter[n].colorMatch['green'])).toFixed(1) + '%];</div>';
									td.innerHTML = sInner;

								}

								if (dxSummaryCounter[n].colorMatch['blue'] > 0){

									var tr = document.createElement('tr');
									tbl.appendChild(tr);
									var td = document.createElement('td');
									td.setAttribute("style",'padding:0 0 0 4px;border-bottom:1px solid #fff;width:500px;height:14px;');
									tr.appendChild(td);

									sInner = '<div style="padding:0"> • '+parseFloat(dxSummaryCounter[n].colorMatch['blue']/dxSummaryCounter[n].counter * 100).toFixed(0)+'% ('+dxSummaryCounter[n].colorMatch['blue']+') scored in <span style="background-Color:#656AFC;color:#fff;width:50px;">[BLUE]</span> group with an average YTD progress score of [' + parseFloat(dxSummaryCounter[n].colorMatch['blue_progress']/(dxSummaryCounter[n].colorMatch['blue'])).toFixed(1) + '%];</div>';
									td.innerHTML = sInner;

								}

							}

						}

					});
					
				}

			});

		}
	
	 })

    function todayDate() {
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth()+1; //January is 0!
        var yyyy = today.getFullYear();

        if(dd<10) {
            dd = '0'+dd
        } 

        if(mm<10) {
            mm = '0'+mm
        } 

        return ( yyyy + '/' + mm + '/' + dd );
    }

	function getPeriodPair(filteredPE){
		var peArr = filteredPE.split('Q');
		if ( parseInt(peArr[1]) == 1 ){
			return ((parseInt(peArr[0])-1)+'Q2');
		}
		if ( parseInt(peArr[1]) == 2 ){
			return ((parseInt(peArr[0])-1)+'Q3');
		}
		if ( parseInt(peArr[1]) == 3 ){
			return ((parseInt(peArr[0])-1)+'Q4');
		}
		if ( parseInt(peArr[1]) == 4 ){
			return (peArr[0]+'Q1');
		}
	}

	 function getPeriodPairEndMM(filteredPE){
		 var peArr = filteredPE.split('Q');
		 if ( parseInt(peArr[1]) == 1 ){
			return (peArr[0]+'03');
		 }
		 if ( parseInt(peArr[1]) == 2 ){
			return (peArr[0]+'06');
		 }
		 if ( parseInt(peArr[1]) == 3 ){
			return (peArr[0]+'09');
		 }
		 if ( parseInt(peArr[1]) == 4 ){
			 return (peArr[0]+'12');
		 }
	 } 

	function loadChart(){

		document.getElementById("chart1Title").innerText = 'Chart 1. Current 90-90-90 Treatment Cascade and Pillars';
		document.getElementById("chart1").style.width = (document.getElementById("tblMaster").offsetWidth + 'px');

		chartPlugin.url = "../";
		//chartPlugin.username = "<username>";
		//chartPlugin.password = "<password>";

		chartPlugin.load([{
		"columns": [
			{
			"dimension": "PI4HF35fhhu",
			"items": [
				{
				"id": "MtGfK0t2bZa",
				"name": "Actual"
				},
				{
				"id": "cxImobqF3HG",
				"name": "Gap"
				}
			]
			}
		],
		"rows": [
			{
			"dimension": "dx",
			"items": [
				{
					"id": "sbX18ESyG75",
					"name": "Living with HIV"
				},
				{
					"id": "lGjaoo85MsS",
					"name": "Knowing their Status"
				},
				{
					"id": "MzpaBBlw9eR",
					"name": "On ART"
				},
				{
					"id": "SeR1DT5EnsX",
					"name": "VLD12"
				},
				{
					"id": "jozmwpXsbvy",
					"name": "VLS12"
				}
			]
			}
		],
		"filters": [
			{
			"dimension": "ou",
			"items": [
				{
				"id": ( ( (dhis2.report.organisationUnitHierarchy.length) <= 3) ? dhis2.report.organisationUnit.id : dhis2.report.organisationUnitHierarchy[1].id),
				"name": ( ( (dhis2.report.organisationUnitHierarchy.length) <= 3) ? dhis2.report.organisationUnit.name : dhis2.report.organisationUnitHierarchy[1].name)
				}
			]
			},
			{
			"dimension": "pe",
			"items": [
				{
				"id": pe,
				"name": peQTRlabelEnd
				}
			]
			}
		],
		"type": "stackedcolumn",
		"percentStackedValues": false,
		"cumulativeValues": false,
		"hideEmptyRowItems": "NONE",
		"showAsEpiCurve": false,
		"hideSubtitle": true,
		"subtitle": '90-90-90 Cascade',
		"url": "",
		"el": "chart1"
		}]);

		//90-90-90 TREATMENT AND RETENTION ACCELERATION PLAN

	}

	function getElementName(dxData,id){
		for (var a = 0; a < dxData.dataElements.length; a++){
			if (dxData.dataElements[a].id == id){
				return dxData.dataElements[a].name;
			}
		}
	}

	function incrDxSummaryMissing(dx){
		for(var i = 0; i < dxSummaryCounter.length; i++){
			if (dxSummaryCounter[i].dx == dx){
				dxSummaryCounter[i].missing += 1;
			}
		}
	}

	function incrDxSummaryCounter(sCol,dx,varVal){
		for(var i = 0; i < dxSummaryCounter.length; i++){
			if (dxSummaryCounter[i].dx == dx){
				dxSummaryCounter[i].counter += 1;
				dxSummaryCounter[i].colorMatch[sCol] += 1;
				dxSummaryCounter[i].colorMatch[sCol+'_progress'] += varVal;
			}
		}
	}

	function getBackgroundPerformanceColor(varVal,dx,bSkipIncr){
		//var dxCore = 'KnQn2N452bE,Bmo4lk1FhgP,fG0NDp9ZcQh,mH17opU6Ivq,gOOE6omxMyL,IsqRJtrTAP6,ePxyv7IJofg';
		var dxOne = 'KnQn2N452bE,Bmo4lk1FhgP,fG0NDp9ZcQh,mH17opU6Ivq';
		if (isNumber(varVal)) {

			if (dxOne.indexOf(dx) >= 0){
				if (parseFloat(varVal) > 110){
					if (bSkipIncr != true){
						incrDxSummaryCounter('blue',dx,parseFloat(varVal));
					}
					return '#656AFC'; // blue
				}
				if ( (parseFloat(varVal) >= 90) && (parseFloat(varVal) <= 110) ){
					if (bSkipIncr != true){
						incrDxSummaryCounter('green',dx,parseFloat(varVal));
					}
					return '#90FC65'; // green
				}
				if ( (parseFloat(varVal) >= 70) && (parseFloat(varVal) < 90) ){
					if (bSkipIncr != true){
						incrDxSummaryCounter('orange',dx,parseFloat(varVal));
					}
					return '#FCDC65'; // orange
				}
				if (parseFloat(varVal) < 70){
					if (bSkipIncr != true){
						incrDxSummaryCounter('red',dx,parseFloat(varVal));
					}
					return '#FC6565'; // red
				}
			} else {
				if (dx == 'Og44c6zMLLT'){
					if (parseFloat(varVal) > 100){
						if (bSkipIncr != true){
						incrDxSummaryCounter('blue',dx,parseFloat(varVal));
					}
						return '#656AFC'; // blue
					}
					if ( (parseFloat(varVal) >= 75) && (parseFloat(varVal) <= 100) ){
						if (bSkipIncr != true){
						incrDxSummaryCounter('green',dx,parseFloat(varVal));
					}
						return '#90FC65'; // green
					}
					if ( (parseFloat(varVal) >= 60) && (parseFloat(varVal) < 75) ){
						if (bSkipIncr != true){
						incrDxSummaryCounter('orange',dx,parseFloat(varVal));
					}
						return '#FCDC65'; // orange
					}
					if (parseFloat(varVal) < 60){
						if (bSkipIncr != true){
						incrDxSummaryCounter('red',dx,parseFloat(varVal));
					}
						return '#FC6565'; // red
					}
				}
				if (dx == 'YrrIYRXd82h'){
					if (parseFloat(varVal) > 100){
						if (bSkipIncr != true){
						incrDxSummaryCounter('blue',dx,parseFloat(varVal));
					}
						return '#656AFC'; // blue
					}
					if ( (parseFloat(varVal) >= 85) && (parseFloat(varVal) <= 100) ){
						if (bSkipIncr != true){
						incrDxSummaryCounter('green',dx,parseFloat(varVal));
					}
						return '#90FC65'; // green
					}
					if ( (parseFloat(varVal) >= 65) && (parseFloat(varVal) < 85) ){
						if (bSkipIncr != true){
						incrDxSummaryCounter('orange',dx,parseFloat(varVal));
					}
						return '#FCDC65'; // orange
					}
					if (parseFloat(varVal) < 65){
						if (bSkipIncr != true){
						incrDxSummaryCounter('red',dx,parseFloat(varVal));
					}
						return '#FC6565'; // red
					}
				}
				if (dx == 'NsrFeZdWd14'){
					if (parseFloat(varVal) > 100){
						if (bSkipIncr != true){
						incrDxSummaryCounter('blue',dx,parseFloat(varVal));
					}
						return '#656AFC'; // blue
					}
					if ( (parseFloat(varVal) >= 85) && (parseFloat(varVal) <= 100) ){
						if (bSkipIncr != true){
						incrDxSummaryCounter('green',dx,parseFloat(varVal));
					}
						return '#90FC65'; // green
					}
					if ( (parseFloat(varVal) >= 24) && (parseFloat(varVal) < 85) ){
						if (bSkipIncr != true){
						incrDxSummaryCounter('orange',dx,parseFloat(varVal));
					}
						return '#FCDC65'; // orange
					}
					if (parseFloat(varVal) < 24){
						if (bSkipIncr != true){
						incrDxSummaryCounter('red',dx,parseFloat(varVal));
					}
						return '#FC6565'; // red
					}
				}
			}
		}
	}

	function paddNumeric(varVal,iPadd){
		var sPadd = '';
		for (var i = (varVal.toString().length); i < iPadd; i++){
			sPadd += '0';
		}
		return (sPadd.toString() + varVal.toString());
	}

	function isNumber(n) {
		return !isNaN(parseFloat(n)) && isFinite(n);
	}

	function returnAttributeValue(Arr,sName,ReturnDefault){
		var sReturn = '';
		for(var i = 0; i < Arr.length; i++) {
			if (Arr[i].attribute.name == sName){
				sReturn = Arr[i].value;
			}
		}
		if (sReturn.length == 0){
			return ReturnDefault
		}
		else{
			return sReturn
		}
	}

	function formatNumber(num) {
		return ("" + num).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, function($1) { return $1 + "," });
	}

	function sortTable(table_id, sortColumn){
		//console.log('sortTable("'+table_id+'",'+sortColumn+')');
		var tableData = document.getElementById(table_id).getElementsByTagName('tbody').item(0);
		var rowData = tableData.getElementsByTagName('tr');            
		for(var i = 0; i < rowData.length - 1; i++){
			for(var j = 0; j < rowData.length - (i + 1); j++){
				//if(Number(rowData.item(j).getElementsByTagName('td').item(sortColumn).innerHTML.replace(/[^0-9\.]+/g, "")) < Number(rowData.item(j+1).getElementsByTagName('td').item(sortColumn).innerHTML.replace(/[^0-9\.]+/g, ""))){
				if(parseFloat(rowData.item(j).getElementsByTagName('td').item(sortColumn).innerHTML.replace(",", "")) < parseFloat(rowData.item(j+1).getElementsByTagName('td').item(sortColumn).innerHTML.replace(",", ""))){
					tableData.insertBefore(rowData.item(j+1),rowData.item(j));
				}
			}
		}
	}

function loadMapFrame(){

	//URL for parent-OU 
	//var sOU = ('../api/organisationUnits/' + ou + '.json?fields=id,name,displayName,displayShortName,coordinates,featureType,level');
	if (dhis2.report.organisationUnitHierarchy.length > 1){
		var sOU = ('../api/organisationUnits.json?filter=id:in:['+dhis2.report.organisationUnitHierarchy[0].id+','+dhis2.report.organisationUnitHierarchy[1].id+']&fields=id,name,coordinates,level,featureType');
	} else {
		var sOU = ('../api/organisationUnits.json?filter=id:in:['+dhis2.report.organisationUnitHierarchy[0].id+']&fields=id,name,coordinates,level,featureType');
	}

	$.ajax({
		url: sOU,
		error: function (xhr, ajaxOptions, thrownError) {
			console.log('error: OrgUnit Lookup');
		},
		success : function(dataOU){

			geojson_decode = function(geoFeatures, levelOrder) {
				/*var geojson = {
					type: 'FeatureCollection',
					crs: {
						type: 'EPSG',
						properties: {
							code: '4326'
						}
					},
					features: []
				};*/
				var geojson = {
					type: 'FeatureCollection',
					features: []
				};

				levelOrder = levelOrder || 'ASC';

				for (var i = 0; i < geoFeatures.organisationUnits.length; i++) {

					if ((geoFeatures.organisationUnits[i].featureType).toUpperCase().indexOf('POLYGON') >= 0) {

						//console.log(JSON.stringify(JSON.parse(geoFeatures.organisationUnits[i].coordinates)[0][0]));

						geojson.features.push({
							type: 'Feature',
							geometry: {
								type: 'Polygon',
								coordinates: JSON.parse(geoFeatures.organisationUnits[i].coordinates)[0] //JSON.parse(geoFeatures.organisationUnits[i].coordinates)[0][0]
							},
							properties: {
								id: geoFeatures.organisationUnits[i].id,
								name: geoFeatures.organisationUnits[i].name,
								shortName: 	geoFeatures.organisationUnits[i].shortName,
								level: geoFeatures.organisationUnits[i].level
							} 
						});

					} else {

						geojson.features.push({
							type: 'Feature',
							geometry: {
								type: geoFeatures.organisationUnits[i].featureType,
								coordinates: JSON.parse(geoFeatures.organisationUnits[i].coordinates)
							},
							properties: {
								id: geoFeatures.organisationUnits[i].id,
								name: geoFeatures.organisationUnits[i].name,
								shortName: geoFeatures.organisationUnits[i].shortName,
								hasCoordinatesDown: '',
								hasCoordinatesUp: '',
								level: geoFeatures.organisationUnits[i].level,
								grandParentParentGraph: '',
								grandParentId: '',
								parentGraph: '',
								parentId: '',
								parentName: '',
								type: ''
							}
						});

					}
				}

				return geojson;
			}

			var g_geoJSONlayerData = geojson_decode(dataOU,true,'Polygon');

			var g_geoJSONlayerObj = L.geoJson(g_geoJSONlayerData, {
				style: AdaptStyle
			}).addTo(g_map);

			setTimeout(function () { g_map.fitBounds(g_geoJSONlayerObj.getBounds()); }, 1000 ) ;



			//g_map.dragging.disable();
			//g_map.touchZoom.disable();
			g_map.doubleClickZoom.disable();
			//g_map.scrollWheelZoom.disable();
			//g_map.boxZoom.disable();
			g_map.keyboard.disable();

			//document.getElementById('SentimentSummary').innerText = 'some positive sentiment, some concerns, etc etc, blah blah blah text container';

		}
	})

}


function AdaptStyle(feature){

	if (feature.properties['id'] == getParameterByName('ou'))	{

		return {
			weight: 2,
			opacity: 0.65,
			color: '#8A3F3F', //000 with 0.65 //916464 dark-red
			dashArray: '0',
			fillOpacity: 0.1,
			fill: '#000'
		}

	} else {

		if (feature.properties['id'] != getParameterByName('ou'))	{

			if (feature.geometry.type == 'Point'){
				return {
					weight: 1,
					opacity: 0.85, 
					color: '#606060', 
					dashArray: '0',
					fillOpacity: 0.85,
					fillColor: '#ffffff', 
					radius: 20,
					className: 'pointShadow'
				}
			} else {
				return {
					weight: 1,
					opacity: 0.5, 
					color: '#606060', 
					dashArray: '0',
					fillOpacity: 0,
					fillColor: '#fff'
				}
			}

		}

	}

}

</script>

</body>
</html>