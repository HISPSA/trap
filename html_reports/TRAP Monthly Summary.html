<html>

<head>

	<style>
		table.MainTbl{
			border-left:2px solid #000;border-top:2px solid #000;border-right:2px solid #000;border-bottom:1px solid #000;font-family:Calibri
		}
		table.SecondaryTbl{
			border-left:1px solid #000;border-top:1px solid #000;border-right:1px solid #000;font-family:Calibri
		}
		th.labelHeader {
			font-weight:800;border-left:1px solid #000;border-bottom:1pt solid #000;text-align:center;padding:4px;color:#000;font-family:Calibri
		}
		th.labelmonthName{
			font-weight:800;border-left:1px solid #000;border-bottom:1pt solid #000;text-align:center;padding:4px;background-Color:#f5f5f5;color:#000;font-family:Calibri
		}
		td.cellNumeric, div.cellNumeric{
			text-align: right;padding:4px;cursor: default;font-family:Calibri
		}
		.rounded{
		    -webkit-border-radius: 4px 4px 4px 4px;
		    -moz-border-radius: 4px 4px 4px 4px;
		    border-radius: 4px 4px 4px 4px;
		}
		table.perfBar { width:100%;height:100;padding:0; }
		table, td, div, span {font-family:Calibri}
	</style>

	<script language=javascript>

		function getParameterByName(name) {0
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results = regex.exec(location.search);
			return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		var ou = getParameterByName('ou');
		var pe = getParameterByName('pe');

	</script>

</head>

<body>


	<div id="reportHeader">
		<table id='logoTable' style="">
			<tr>
				<td style='width:225px;text-align:left;'> <img src='http://timesheets.hisp.org/timesheets/images/new%20health%20logo-2.jpg' style='width:225px;height:80px;'> </td>
				<td > </td>
				<td style='width:180px;text-align:right;'> <img src='http://timesheets.hisp.org/timesheets/images/southafrica_pepfarlogo.jpg' style='width:155px;height:100px;'> </td>
			</tr>
			<tr>
				<td></td>
				<td style='text-align:center;'>
					<strong style='font-size:14pt;'>90-90-90 TREATMENT AND RETENTION ACCELERATION PLAN MONTHLY REPORT</strong>
				</td>
				<td></td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:center;padding:4px 0 0 0;'>
					<div style='font-size:12pt;' id='ouName'></div>
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:center;'>
					<div style='font-size:12pt;' id='peSummary'></div>
				</td>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					<strong>&nbsp; 1. &nbsp; BACKGROUND</strong>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					South Africa adopted the UNAIDS 90, 90, 90 targets for HIV in 2014, which aim to ensure that by 2020:<br><br>
					•	 90% of all people living with HIV will know their HIV status<br>
					•	 90% of all people with diagnosed HIV infection will receive sustained antiretroviral therapy<br>
					•	 90% of all people receiving antiretroviral therapy will have viral suppression.<br><br>
					It’s estimated that 7.1 million South Africans are living with HIV, of which 3.8 million are on ART. The National Department of Health is committed to achieving the above targets by addressing the challenges contributing to HIV programme suboptimal performance.
				</td>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
	
			<tr>
				<td colspan=3 style='text-align:left;'>
					<strong>&nbsp; 2. &nbsp; PURPOSE</strong>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;padding: 0 0 0 4px;'>
					The purpose of this report is to improve accountability and ownership at all levels of care through close monitoring, timely remedial actions and rapid mitigation. The indicators listed below must be monitored closely against set targets.
				</td>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					<strong>&nbsp; 3. &nbsp; How indicators are monitored</strong>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					The coloured bars provide a quick way of tracking progress made with regard to a particular indicator. The indicators are represented by green, yellow, red and blue bars. The colours mean the following:<br><br>
					<div style="color:red">Red: Critical</div>
					<div style="color:orange">Orange: Need to improve</div>
					<div style="color:green">Green: The indicator is close to or reached its target value</div>
					<div style="color:blue">Blue: Needs explanation</div><br>
					<!-- Colour ranges for the indicators have been set as follows: -->
					
					The purpose of this report is to improve accountability and ownership at all levels of care through close monitoring, timely remedial actions and rapid mitigation. The following indicators must be monitored closely against set targets:
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					<div id='dxList'></div>
				</td>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3 style='text-align:left;'>
					<strong>&nbsp; 4. &nbsp;Ranking per indicator</strong>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;
				</td>
			</tr>
			<tr>
				<td colspan=3>
					&nbsp;Organisational units are ranked from those with the largest gap to those with the smallest gap in relation to the targets for the individual indicators
				</td>
			</tr>
		</table>

	</div>

<div id="" style="padding:0">
<div id='table1Title'></div>
<table border=0 cellpadding=0 cellspacing=0 style='min-width:75%;' id='tblMaster' class='MainTbl rounded'>
	<thead>
		<tr>
			<th colspan=1 rowspan=2 class='labelHeader' style='border-left:0;'>{PLACEHOLDER}</th>
			<th colspan=1 rowspan=2 class='labelHeader' id='1_peFprev'></th>
			<th colspan=1 rowspan=2 class='labelHeader' id='1_peFtarget'></th>
			<th colspan=4 rowspan=1 class='labelHeader' id='1_FYspan'></th>
			<th colspan=1 rowspan=2 class='labelHeader' id='1_peMMtarget'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM04'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM05'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM06'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM07'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM08'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM09'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM10'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM11'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM12'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM01'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM02'></th>
			<th colspan=1 rowspan=2 class='labelmonthName' id='1_peMM03'></th>
		</tr>
		<tr>
			<th colspan=1 class='labelHeader' id='1_peFYTDtarget'></th>
			<th colspan=1 class='labelHeader' id='1_peFYTDactual'></th>
			<th colspan=1 class='labelHeader' id='1_peFYTDgap'></th>
			<th colspan=1 class='labelHeader' id='1_peFYTDprogress'></th>
		</tr>
	</thead>
</table>

</div>

<input type="button" value="Export to Excel" id="exceldownloadbutton" name="exceldownloadbutton" onclick="javascript:fnExcelReport()" class="no-print" style="display:none;width:140px;position:absolute;left:306px;top:65px;">

 <script language=javascript>


	var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ];
	//var dxCore = 'fG0NDp9ZcQh,mH17opU6Ivq,KnQn2N452bE,Bmo4lk1FhgP,S6BlQpoZVhQ';
	var dxCore = 'KnQn2N452bE,Bmo4lk1FhgP,fG0NDp9ZcQh,mH17opU6Ivq'; //,gOOE6omxMyL,IsqRJtrTAP6,ePxyv7IJofg'; //S6BlQpoZVhQ: TB screening REMOVED Temporarily (2018-02-09)
	var dxCoreArr = dxCore.split(',')
	var dxCat = 'wyZ6KAmjZeD,mLVlvjLwl9q';
	var dxCoreCat = '';
	var lblCat = 'Actual,Target';
	var dxNonRunningTotal = 'mH17opU6Ivq';
	var peMMrange = '';
	var peMMrangeEnd = '';
	var peMMlabelEnd = '';
	var peMMprevYRangeEnd = '';
	var peMMcurrYRangeEnd = '';

	var sort_by = function(field, reverse, primer){
		var key = primer ? 
			function(x) {return primer(x[field])} : 
			function(x) {return x[field]};
		reverse = !reverse ? 1 : -1;
		return function (a, b) {
			return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
			} 
	}

	var peMcurr = parseInt(pe.substring(4,6));
	var peFcurr = parseInt(pe.substring(0,4));

	if (peMcurr <= 3){
		peFcurr = (peFcurr-1);
	}

	var peFprev = (peFcurr-1); //parseInt(((parseInt(peMcurr)<4) ? (peFcurr-1) : peFcurr));
	var peFcurrSuff = parseInt(peFcurr.toString().substring(2,4));
	var peFprevSuff = parseInt(peFprev.toString().substring(2,4));

	var peFYcurr = (peFcurr+'April');
	var peFYprev = (peFprev+'April');

	if (dxNonRunningTotal.length > 0) {
		peMMprevYRangeEnd = (peFcurr + '03');
	}

	peMMcurrYRangeEnd = ((peFcurr+1) + '03');

	document.getElementById('1_peFprev').innerHTML = (peFprev + '/' + peFcurrSuff + '<br>Baseline');
	document.getElementById('1_peFtarget').innerHTML = (peFcurr + '/' + ((peFcurrSuff)+1) + '<br>Target');

	document.getElementById('1_FYspan').innerHTML = ('YTD ' + peFcurr + '/' + ((peFcurrSuff)+1) + '');

	document.getElementById('1_peFYTDtarget').innerHTML = ('Target');
	document.getElementById('1_peFYTDactual').innerHTML = ('Actual');
	document.getElementById('1_peFYTDgap').innerHTML = ('Gap');
	document.getElementById('1_peFYTDprogress').innerHTML = ('Progress');

	document.getElementById('1_peMMtarget').innerHTML = (peFcurr + '/' + ((peFcurrSuff)+1) + '<br>Monthly<br>Target');


	for (var p = 4; p <= 12; p++){
		document.getElementById('1_peMM' + paddNumeric(p,2)).innerHTML = ((months[p-1]).toString().substring(0,3)+'-'+peFcurrSuff);
		if ( (p > peMcurr) && (peMcurr > 4) ){
			document.getElementById('1_peMM' + paddNumeric(p,2)).style.display='none';
		} else {
			peMMrange += (peFcurr+paddNumeric(p,2)+';');
			peMMlabelEnd = ((months[p-1]).toString().substring(0,3)+'-'+peFcurrSuff);
			peMMrangeEnd = (peFcurr+paddNumeric(p,2));
		}
	}
	for (var p = 1; p <= 3; p++){
		document.getElementById('1_peMM' + paddNumeric(p,2)).innerHTML = ((months[p-1]).toString().substring(0,3)+'-'+(peFcurrSuff+1));
		if ( (peMcurr > 3) || (p > peMcurr) ){
			document.getElementById('1_peMM' + paddNumeric(p,2)).style.display='none';
		} else {
			peMMrange += ((peFcurr+1)+paddNumeric(p,2)+';');
			peMMlabelEnd = ((months[p-1]).toString().substring(0,3)+'-'+(peFcurrSuff+1));
			peMMrangeEnd = ((peFcurrSuff+1)+paddNumeric(p,2));
		}
	}

	var template1 = document.getElementById('tblMaster').outerHTML.replace('MainTbl','SecondaryTbl');

	document.getElementById('tblMaster').outerHTML = document.getElementById('tblMaster').outerHTML.replace('{PLACEHOLDER}',dhis2.report.organisationUnit.name)

	for (var p = 4; p <= 12; p++){
		document.getElementById('1_peMM' + paddNumeric(p,2)).innerHTML = ((months[p-1]).toString().substring(0,3)+'-'+peFcurrSuff);
	}
	for (var p = 1; p <= 3; p++){
		document.getElementById('1_peMM' + paddNumeric(p,2)).innerHTML = ((months[p-1]).toString().substring(0,3)+'-'+(peFcurrSuff+1));
	}

	var myYTDCALCvals = [];

	//URL for Dx Core List
	var sDxCore = ('../api/dataElements.json?filter=id:in:['+dxCore+']&fields=id,name,shortName,displayName');

	 $.ajax({
		url: sDxCore,
		error: function (xhr, ajaxOptions, thrownError) {
			console.log('error: Data Element Lookup');
		},
		success : function(dataDE){

			var sort_by = function(field, reverse, primer){

			var key = primer ? 
				function(x) {return primer(x[field])} : 
				function(x) {return x[field]};

			reverse = !reverse ? 1 : -1;

			return function (a, b) {
				return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
				} 
			}

			var ArrDx = dxCore.split(',');
			var tbl1 = document.getElementById('tblMaster');
			var tbody = document.createElement('tbody');
			tbl1.appendChild(tbody);

			//for (var p = 0; p < dataDE.dataElements.length; p++){
			for (var p = 0; p < dxCoreArr.length; p++){

				myYTDCALCvals.push ({
					ou: ou,
					dx: dxCoreArr[p],
					baseline: 0,
					FYtarget: 0,
					YTDtarget: 0,
					YTDactual: 0,
					YTDgapNum: 0,
					YTDgapPer: 0,
					CALCtarget: 0,
					CALCactual: 0,
					GrandTotAll: 0,
					MM04: 0,
					MM05: 0,
					MM06: 0,
					MM07: 0,
					MM08: 0,
					MM09: 0,
					MM10: 0,
					MM11: 0,
					MM12: 0,
					MM01: 0,
					MM02: 0,
					MM03: 0
				});

				var tr = document.createElement('tr');
				tr.setAttribute("id",dxCoreArr[p]+'_'+ou+'_row');
				tbody.appendChild(tr);

				var td = document.createElement('td');
				td.setAttribute("style",'padding:3px;border-bottom:1px solid #000;width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;');
				td.setAttribute("id",'1_'+dxCoreArr[p]+'_1');
				tr.appendChild(td);

				//td.innerText = (dataDE.dataElements[p].name).replace('TRAP_','');
				td.innerText = (getElementName(dataDE,dxCoreArr[p])).replace('TRAP_','');

				document.getElementById('dxList').innerHTML += ('<div style="padding:2px 0 2px 2px"> • ' + (getElementName(dataDE,dxCoreArr[p])).replace('TRAP_','')+'</div>')

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+peFYprev);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				td.setAttribute("id",dxCoreArr[p]+'.mLVlvjLwl9q_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				td.setAttribute("id",dxCoreArr[p]+'.YTDtarget_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				td.setAttribute("id",dxCoreArr[p]+'.YTDactual_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				td.setAttribute("id",dxCoreArr[p]+'.DifferenceGap_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("id",dxCoreArr[p]+'.DifferencePercentage_'+ou+'_'+peFYcurr);
				tr.appendChild(td);

				var td = document.createElement('td');
				td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
				td.setAttribute("class",'cellNumeric');
				td.setAttribute("id",dxCoreArr[p]+'.mLVlvjLwl9q_'+ou+'_'+peMMrange.split(';')[0]);
				tr.appendChild(td);

				for (var r = 4; r <= 12; r++){
					if ( (r <= peMcurr) || (peMcurr <= 4) ){
						var td = document.createElement('td');
						td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
						td.setAttribute("class",'cellNumeric');
						td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+peFcurr+paddNumeric(r,2));
						tr.appendChild(td);
					}
				}
				for (var r = 1; r <= 3; r++){
					if ( (r <= peMcurr) && (peMcurr <= 4) ){
						var td = document.createElement('td');
						td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
						td.setAttribute("class",'cellNumeric');
						td.setAttribute("id",dxCoreArr[p]+'.wyZ6KAmjZeD_'+ou+'_'+(peFcurr+1)+paddNumeric(r,2));
						tr.appendChild(td);
					}
				}

			}

			var dv = document.createElement('div');
			dv.setAttribute('style','padding:12px 0 8px 4px;');
			dv.innerText = 'Table 1. Monthly Summary for '+dhis2.report.organisationUnit.name+' (F' + peFcurr + ', ending ' + peMMlabelEnd + ')';
			document.getElementById('table1Title').appendChild(dv);

			var dxArrCore = dxCore.split(',')
			var dxArrCat = dxCat.split(',')

			for (var n = 0; n < dxArrCore.length; n++){
				for (var o = 0; o < dxArrCat.length; o++){
					dxCoreCat += (dxArrCore[n]+'.'+dxArrCat[o]+';');
				}
			}

			dxCoreCat = dxCoreCat.substring(dxCoreCat,dxCoreCat.length-1);

			//URL for parent-OU 
			var sOU = ('../api/organisationUnits/' + ou + '.json?fields=id,name,displayName,displayShortName,level,children[id,name,displayName,displayShortName,level]');

			$.ajax({
				url: sOU,
				error: function (xhr, ajaxOptions, thrownError) {
					console.log('error: Data Element Lookup');
				},
				success : function(dataOU){

					var OUchildren = '';

					for (var p = 0; p < dataOU.children.length; p++){
						OUchildren += (dataOU.children[p].id + ';');
					}

					OUchildren = OUchildren.substring(OUchildren,OUchildren.length-1);

					for (var n = 0; n < dataDE.dataElements.length; n++){

						var dv1 = document.createElement('div');
						dv1.setAttribute('style','padding:12px 0 4px 4px;');
						dv1.innerText = 'Table '+(n+2)+'. '+(dataDE.dataElements[n].name).replace('TRAP_','')+'';
						//dv.appendChild(dv1);
						document.getElementById('mainPage').appendChild(dv1);

						var dv = document.createElement('div');
						dv.setAttribute('id','dv_'+dataDE.dataElements[n].id);
						dv.setAttribute('style','padding:8px 0 8px 0;');
						document.getElementById('mainPage').appendChild(dv);

						dv.innerHTML = (template1.replace('tblMaster','tblDx_'+dataDE.dataElements[n].id));
						dv.innerHTML = (dv.innerHTML).replace('{PLACEHOLDER}',dataDE.dataElements[n].name).replace('TRAP_','');

						var tbl1 = document.getElementById('tblDx_'+dataDE.dataElements[n].id);
						var tbody = document.createElement('tbody');
						tbl1.appendChild(tbody);

						for (var p = 0; p < dataOU.children.length; p++){

							myYTDCALCvals.push ({
								ou: dataOU.children[p].id,
								dx: dataDE.dataElements[n].id,
								baseline: 0,
								FYtarget: 0,
								YTDtarget: 0,
								YTDactual: 0,
								YTDgapNum: 0,
								YTDgapPer: 0,
								CALCtarget: 0,
								CALCactual: 0,
								GrandTotAll: 0,
								MM04: 0,
								MM05: 0,
								MM06: 0,
								MM07: 0,
								MM08: 0,
								MM09: 0,
								MM10: 0,
								MM11: 0,
								MM12: 0,
								MM01: 0,
								MM02: 0,
								MM03: 0
							});

							var tr = document.createElement('tr');
							tr.setAttribute("id",dataDE.dataElements[n].id+'_'+dataOU.children[p].id+'_row');
							tbody.appendChild(tr);

							var td = document.createElement('td');
							td.setAttribute("style",'padding:3px;border-bottom:1px solid #000;width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;');
							td.setAttribute("id",dataDE.dataElements[n].id+'_'+dataOU.children[p].id+'_0');
							tr.appendChild(td);

							td.innerText = (dataOU.children[p].name);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dataDE.dataElements[n].id+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+peFYprev);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							//td.setAttribute("id",dataDE.dataElements[n].id+'_'+dataOU.children[p].id+'_2');
							td.setAttribute("id",dataDE.dataElements[n].id+'.mLVlvjLwl9q_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dataDE.dataElements[n].id+'.YTDtarget_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dataDE.dataElements[n].id+'.YTDactual_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dataDE.dataElements[n].id+'.DifferenceGap_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							//td.setAttribute("class",'cellNumeric');
							//td.setAttribute("id",dataDE.dataElements[n].id+'_'+dataOU.children[p].id+'_6');
							td.setAttribute("id",dataDE.dataElements[n].id+'.DifferencePercentage_'+dataOU.children[p].id+'_'+peFYcurr);
							tr.appendChild(td);

							var td = document.createElement('td');
							td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;');
							td.setAttribute("class",'cellNumeric');
							td.setAttribute("id",dataDE.dataElements[n].id+'.mLVlvjLwl9q_'+dataOU.children[p].id+'_'+peMMrange.split(';')[0]);
							tr.appendChild(td);

							for (var r = 4; r <= 12; r++){
								if ( (r <= peMcurr) || (peMcurr <= 4) ){
									var td = document.createElement('td');
									td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
									td.setAttribute("class",'cellNumeric');
									td.setAttribute("id",dataDE.dataElements[n].id+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+peFcurr+paddNumeric(r,2));
									tr.appendChild(td);
								}
							}
							for (var r = 1; r <= 3; r++){
								if ( (r <= peMcurr) && (peMcurr <= 4) ){
									var td = document.createElement('td');
									td.setAttribute("style",'border-bottom:1px solid #000;border-left:1px solid #000;background-Color:#f5f5f5');
									td.setAttribute("class",'cellNumeric');
									td.setAttribute("id",dataDE.dataElements[n].id+'.wyZ6KAmjZeD_'+dataOU.children[p].id+'_'+(peFcurr+1)+paddNumeric(r,2));
									tr.appendChild(td);
								}
							}

						}

					}

					var sDataGet = '../api/26/analytics.json?dimension=dx:'+dxCore.replace(',',';')+';'+dxCoreCat+'&dimension=pe:'+peMMcurrYRangeEnd+';'+( (peMMprevYRangeEnd.length > 0) ? (peMMprevYRangeEnd + ';') : '' )+peMMrange+peFYcurr+';'+peFYprev+'&dimension=ou:'+ou+';'+OUchildren+'&displayProperty=NAME&outputIdScheme=UID';
					//console.log(sDataGet);

					$.ajax({
						url: sDataGet,
						error: function (xhr, ajaxOptions, thrownError) {
							console.log('error: getting report data values');
						},
						success : function(dataVal){

							var comboRESULTALL = [];

							for (var i = 0; i < dataVal.rows.length; i++){

								var myRowID = (dataVal.rows[i][0] + '_' + dataVal.rows[i][2] + '_' + dataVal.rows[i][1]);
								var myValue = dataVal.rows[i][3];

								comboRESULTALL.push ({ id: myRowID, value: myValue });

								try {
									document.getElementById(myRowID).innerText = formatNumber(parseFloat(myValue).toFixed(1).toString().replace('.0',''));
								}
								catch(err) {
									//console.log('No match: '+myRowID +': ['+myValue+']')
								}

							}

							var PEarr = peMMrange.substring(peMMrange,peMMrange.length-1).split(';')

							for (var a = 0; a < myYTDCALCvals.length; a++){

								for (var i = 0; i < comboRESULTALL.length; i++){

									// DX and OU match
									if ( ( (comboRESULTALL[i].id).indexOf(myYTDCALCvals[a].dx) >= 0) && ( (comboRESULTALL[i].id).indexOf(myYTDCALCvals[a].ou) >= 0) ){

										if ( ( (comboRESULTALL[i].id).indexOf(peFYprev) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) < 0) ) {
											myYTDCALCvals[a].baseline = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
										} else {
											// PE match of Prev-Year-End-MM value for RunningTotal element
											if ( ( (comboRESULTALL[i].id).indexOf(peMMprevYRangeEnd) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].baseline = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
										}

										// YTD target
										if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && ( (comboRESULTALL[i].id).indexOf(peFYcurr) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) < 0) ) {
											//myYTDCALCvals[a].YTDtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											myYTDCALCvals[a].FYtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
										} else {
											// PE match of Current-Range-End-MM value for RunningTotal element
											if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && ( (comboRESULTALL[i].id).indexOf(peMMcurrYRangeEnd ) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].FYtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
											// PE match of Current-Range-End-MM value for RunningTotal element
											if ( ( (comboRESULTALL[i].id).indexOf('mLVlvjLwl9q') >= 0) && ( (comboRESULTALL[i].id).indexOf(peMMrangeEnd ) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].YTDtarget = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
										}

										// YTD actual
										if ( ( (comboRESULTALL[i].id).indexOf('wyZ6KAmjZeD') >= 0) && ( (comboRESULTALL[i].id).indexOf(peFYcurr) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) < 0) ) {
											myYTDCALCvals[a].YTDactual = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
										} else {
											// PE match of Current-Range-End-MM value for RunningTotal element
											if ( ( (comboRESULTALL[i].id).indexOf('wyZ6KAmjZeD') >= 0) && ( (comboRESULTALL[i].id).indexOf(peMMrangeEnd) >= 0) && ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) >= 0) ) {
												myYTDCALCvals[a].YTDactual = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												myYTDCALCvals[a].CALCactual = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
										}

										for (var p = 0; p < PEarr.length; p++){
											if ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) < 0){
												// YTD CALC of TARGET
												if ( ( (comboRESULTALL[i].id).indexOf('.mLVlvjLwl9q') >= 0) && ((comboRESULTALL[i].id).indexOf(PEarr[p]) >= 0) ) {
													myYTDCALCvals[a].YTDtarget += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												}
											}
											// YTD CALC of TARGET
											if ( ( (comboRESULTALL[i].id).indexOf('.mLVlvjLwl9q') >= 0) && ((comboRESULTALL[i].id).indexOf(PEarr[p]) >= 0) ) {
												myYTDCALCvals[a].CALCtarget += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
											// ACTUAL
											if ( ( (comboRESULTALL[i].id).indexOf('.wyZ6KAmjZeD') >= 0) && ((comboRESULTALL[i].id).indexOf(PEarr[p]) >= 0) ) {
												myYTDCALCvals[a].CALCactual += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
												//myYTDCALCvals[a]['MM'+p] = (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);
											}
											
										}

										myYTDCALCvals[a].GrandTotAll += (isNumber(comboRESULTALL[i].value) ? parseFloat(comboRESULTALL[i].value) : 0);

									}

								}

							}

							for (var a = 0; a < myYTDCALCvals.length; a++){


								document.getElementById(myYTDCALCvals[a].dx+'.wyZ6KAmjZeD_'+myYTDCALCvals[a].ou+'_'+peFYprev).innerText = formatNumber( parseFloat(myYTDCALCvals[a].baseline) );
								document.getElementById(myYTDCALCvals[a].dx+'.mLVlvjLwl9q_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].FYtarget) );
								document.getElementById(myYTDCALCvals[a].dx+'.YTDtarget_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].YTDtarget) );
								document.getElementById(myYTDCALCvals[a].dx+'.YTDactual_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( parseFloat(myYTDCALCvals[a].YTDactual) );
								document.getElementById(myYTDCALCvals[a].dx+'.DifferenceGap_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerText = formatNumber( (parseFloat(myYTDCALCvals[a].YTDtarget) - parseFloat(myYTDCALCvals[a].YTDactual)).toFixed(0) );


								if (myYTDCALCvals[a].YTDtarget > 0) {
									var iW = parseFloat(parseFloat(myYTDCALCvals[a].YTDactual) / parseFloat(myYTDCALCvals[a].YTDtarget) * 100 ).toFixed(0);
									document.getElementById(myYTDCALCvals[a].dx+'.DifferencePercentage_'+myYTDCALCvals[a].ou+'_'+peFYcurr).innerHTML = '<div class="perfBar"><div class="cellNumeric" style="padding:4px 4px 0px 4px">' + formatNumber( (parseFloat(myYTDCALCvals[a].YTDactual) / parseFloat(myYTDCALCvals[a].YTDtarget) * 100 ).toFixed(0)) + '%' + '</div><div style="position:relative;left:0;top:0;width:' + ( (parseInt(iW) > 0) ? (parseInt(iW)) : 0)  + '%;height:4px;border-top:1px solid #f5f5f5;border-right:1px solid #f5f5f5;background-Color:'+getBackgroundPerformanceColor(iW,myYTDCALCvals[a].dx)+';">&nbsp;</div></div>';
								}

								if ( (dxNonRunningTotal).indexOf(myYTDCALCvals[a].dx) >= 0){
									document.getElementById(myYTDCALCvals[a].dx+'.mLVlvjLwl9q_'+myYTDCALCvals[a].ou+'_'+peMMrange.split(';')[0]).innerHTML = '<span color="#808080">*</span> ' + formatNumber( parseFloat(parseFloat(myYTDCALCvals[a].CALCtarget) / (PEarr.length) ).toFixed(0) ); /// (PEarr.length+1)
									document.getElementById(myYTDCALCvals[a].dx+'.mLVlvjLwl9q_'+myYTDCALCvals[a].ou+'_'+peMMrange.split(';')[0]).title = 'Average TARGET of monthly values';
								}

								if (myYTDCALCvals[a].GrandTotAll == 0) { 
									document.getElementById(myYTDCALCvals[a].dx+'_'+myYTDCALCvals[a].ou+'_row').style.display = 'none';
								}

							}

							document.getElementById('ouName').innerText = dhis2.report.organisationUnit.name;
							document.getElementById('peSummary').innerText = ('Financial year ' + peFcurr + '/' + ((peFcurrSuff)+1) + ', period ending ' + peMMlabelEnd);
							document.getElementById("logoTable").style.width = (document.getElementById("tblMaster").offsetWidth + 'px');

							//setTimeout(function () { sortTable('tblMaster', 5); }, 1500);

							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[0], 5); }, 1000 ) ;
							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[1], 5); }, 1100 ) ;
							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[2], 5); }, 1200 ) ;
							setTimeout(function () { sortTable('tblDx_'+dxCoreArr[3], 5); }, 1300 ) ;
							//setTimeout(function () { sortTable('tblDx_'+dxCoreArr[4], 5); }, 1400 ) ;

						}

					});

				}	

			});

		}

	 })

	function getElementName(dxData,id){
		for (var a = 0; a < dxData.dataElements.length; a++){
			if (dxData.dataElements[a].id == id){
				return dxData.dataElements[a].name;
			}
		}
	}


	function getBackgroundPerformanceColor(varVal,dx){
		//var dxCore = 'KnQn2N452bE,Bmo4lk1FhgP,fG0NDp9ZcQh,mH17opU6Ivq,gOOE6omxMyL,IsqRJtrTAP6,ePxyv7IJofg';
		var dxOne = 'KnQn2N452bE,Bmo4lk1FhgP,fG0NDp9ZcQh,mH17opU6Ivq';
		if (isNumber(varVal)) {

			if (dxOne.indexOf(dx) >= 0){
				if (parseFloat(varVal) > 110){
					return '#656AFC'; // blue
				}
				if ( (parseFloat(varVal) >= 90) && (parseFloat(varVal) <= 110) ){
					return '#90FC65'; // green
				}
				if ( (parseFloat(varVal) >= 70) && (parseFloat(varVal) < 90) ){
					return '#FCDC65'; // orange
				}
				if (parseFloat(varVal) < 70){
					return '#FC6565'; // red
				}
			} else {
				if (dx == 'gOOE6omxMyL'){
					if (parseFloat(varVal) > 100){
						return '#656AFC'; // blue
					}
					if ( (parseFloat(varVal) >= 75) && (parseFloat(varVal) <= 100) ){
						return '#90FC65'; // green
					}
					if ( (parseFloat(varVal) >= 60) && (parseFloat(varVal) < 75) ){
						return '#FCDC65'; // orange
					}
					if (parseFloat(varVal) < 60){
						return '#FC6565'; // red
					}
				}
				if (dx == 'IsqRJtrTAP6'){
					if (parseFloat(varVal) > 100){
						return '#656AFC'; // blue
					}
					if ( (parseFloat(varVal) >= 85) && (parseFloat(varVal) <= 100) ){
						return '#90FC65'; // green
					}
					if ( (parseFloat(varVal) >= 65) && (parseFloat(varVal) < 85) ){
						return '#FCDC65'; // orange
					}
					if (parseFloat(varVal) < 65){
						return '#FC6565'; // red
					}
				}
				if (dx == 'ePxyv7IJofg'){
					if (parseFloat(varVal) > 100){
						return '#656AFC'; // blue
					}
					if ( (parseFloat(varVal) >= 85) && (parseFloat(varVal) <= 100) ){
						return '#90FC65'; // green
					}
					if ( (parseFloat(varVal) >= 24) && (parseFloat(varVal) < 85) ){
						return '#FCDC65'; // orange
					}
					if (parseFloat(varVal) < 24){
						return '#FC6565'; // red
					}
				}
			}
		}
	}

	function paddNumeric(varVal,iPadd){
		var sPadd = '';
		for (var i = (varVal.toString().length); i < iPadd; i++){
			sPadd += '0';
		}
		return (sPadd.toString() + varVal.toString());
	}

	function isNumber(n) {
		return !isNaN(parseFloat(n)) && isFinite(n);
	}

	function returnAttributeValue(Arr,sName,ReturnDefault){
		var sReturn = '';
		for(var i = 0; i < Arr.length; i++) {
			if (Arr[i].attribute.name == sName){
				sReturn = Arr[i].value;
			}
		}
		if (sReturn.length == 0){
			return ReturnDefault
		}
		else{
			return sReturn
		}
	}

	function formatNumber(num) {
		return ("" + num).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, function($1) { return $1 + "," });
	}

	function sortTable(table_id, sortColumn){
		//console.log('sortTable("'+table_id+'",'+sortColumn+')');
		var tableData = document.getElementById(table_id).getElementsByTagName('tbody').item(0);
		var rowData = tableData.getElementsByTagName('tr');            
		for(var i = 0; i < rowData.length - 1; i++){
			for(var j = 0; j < rowData.length - (i + 1); j++){
				//if(Number(rowData.item(j).getElementsByTagName('td').item(sortColumn).innerHTML.replace(/[^0-9\.]+/g, "")) < Number(rowData.item(j+1).getElementsByTagName('td').item(sortColumn).innerHTML.replace(/[^0-9\.]+/g, ""))){
				if(parseFloat(rowData.item(j).getElementsByTagName('td').item(sortColumn).innerHTML.replace(",", "")) < parseFloat(rowData.item(j+1).getElementsByTagName('td').item(sortColumn).innerHTML.replace(",", ""))){
					tableData.insertBefore(rowData.item(j+1),rowData.item(j));
				}
			}
		}
	}

</script>

</body>
</html>